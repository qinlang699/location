<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ é«˜å¾·æ™ºèƒ½è¶…ç²¾å‡†å®šä½ç³»ç»Ÿ</title>
    <meta property="og:title" content="é«˜å¾·æ™ºèƒ½è¶…ç²¾å‡†å®šä½ç³»ç»Ÿ" />
    <meta property="og:type" content="website" />
    <meta property="og:description" content="åŸºäºé«˜å¾·åœ°å›¾JS API 2.0çš„è¶…é«˜ç²¾åº¦å®šä½ç³»ç»Ÿï¼Œæ”¯æŒGPSã€WiFiã€åŸºç«™æ··åˆå®šä½" />
    
    <!-- å¼•å…¥é«˜å¾·åœ°å›¾JS API 2.0å’Œå®šä½æ’ä»¶ -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=dcfb48c0f9cb749e59c5031e83cb6e95&plugin=AMap.Geolocation"></script>
    
    <style>
        /* ===============================================
           å…¨å±€æ ·å¼è®¾ç½®
           =============================================== */
        ::-webkit-scrollbar {
            width: 12px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #1890ff, #40a9ff);
            border-radius: 6px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, #096dd9, #1890ff);
        }
        
        * {
            -webkit-tap-highlight-color: transparent !important;
            outline: none !important;
        }
        
        /* ===============================================
           åŸºç¡€å¸ƒå±€æ ·å¼
           =============================================== */
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 120, 120, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(120, 120, 120, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 120, 120, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.1),
                0 10px 20px rgba(0,0,0,0.05),
                inset 0 1px 0 rgba(255,255,255,0.2);
            max-width: 900px;
            margin: 0 auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            box-sizing: border-box;
            position: relative;
            z-index: 2;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* ===============================================
           å®šä½ä¿¡æ¯å¡ç‰‡æ ·å¼
           =============================================== */
        .location-info-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 
                0 8px 16px rgba(0,0,0,0.1),
                inset 0 1px 0 rgba(255,255,255,0.8);
            border: 1px solid rgba(24, 144, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .location-info-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #1890ff, #40a9ff, #1890ff);
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .location-method {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .method-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #1890ff, #40a9ff);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 4px 8px rgba(24, 144, 255, 0.3);
        }
        
        .method-info {
            flex: 1;
        }
        
        .method-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .method-desc {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }
        
        /* ===============================================
           æŒ‰é’®æ ·å¼
           =============================================== */
        .location-button {
            background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%);
            color: white;
            padding: 18px 40px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            margin: 20px auto;
            display: block;
            min-width: 280px;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 8px 20px rgba(24, 144, 255, 0.3),
                0 4px 8px rgba(24, 144, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .location-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .location-button:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 30px rgba(24, 144, 255, 0.4),
                0 8px 15px rgba(24, 144, 255, 0.3);
        }
        
        .location-button:hover::before {
            left: 100%;
        }
        
        .location-button:active {
            transform: translateY(0);
            box-shadow: 
                0 6px 15px rgba(24, 144, 255, 0.3),
                0 3px 6px rgba(24, 144, 255, 0.2);
        }
        
        .location-button:disabled {
            background: linear-gradient(135deg, #ccc, #999);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .location-button:disabled::before {
            display: none;
        }
        
        /* ===============================================
           çŠ¶æ€æ˜¾ç¤ºæ ·å¼
           =============================================== */
        .status {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .status.loading {
            background: linear-gradient(135deg, #e6f7ff, #bae7ff);
            color: #1890ff;
            border: 2px solid rgba(24, 144, 255, 0.2);
            animation: pulse 2s ease-in-out infinite;
        }
        
        .status.loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(24, 144, 255, 0.1), transparent);
            animation: loading-wave 1.5s linear infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        @keyframes loading-wave {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .status.success {
            background: linear-gradient(135deg, #f6ffed, #d9f7be);
            color: #52c41a;
            border: 2px solid rgba(82, 196, 26, 0.2);
        }
        
        .status.error {
            background: linear-gradient(135deg, #fff2f0, #ffccc7);
            color: #ff4d4f;
            border: 2px solid rgba(255, 77, 79, 0.2);
        }
        
        /* ===============================================
           ä¿¡æ¯å¡ç‰‡æ ·å¼
           =============================================== */
        .info-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 
                0 8px 20px rgba(0,0,0,0.1),
                0 4px 8px rgba(0,0,0,0.05);
            border-left: 5px solid;
            position: relative;
            backdrop-filter: blur(5px);
        }
        
        .coordinates-card {
            border-left-color: #1890ff;
        }
        
        .accuracy-card {
            border-left-color: #fa8c16;
        }
        
        .address-card {
            border-left-color: #52c41a;
        }
        
        .info-card h3 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-item {
            margin: 12px 0;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-item:hover {
            background: rgba(24, 144, 255, 0.05);
            padding-left: 10px;
            border-radius: 8px;
        }
        
        .info-label {
            font-weight: bold;
            color: #333;
            min-width: 120px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-value {
            color: #666;
            flex: 1;
            font-family: 'Courier New', monospace;
        }
        
        /* ===============================================
           ç²¾åº¦ç­‰çº§æ ·å¼
           =============================================== */
        .accuracy-level {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            gap: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .level-excellent { 
            background: linear-gradient(135deg, #f6ffed, #d9f7be); 
            color: #52c41a; 
            border: 2px solid rgba(82, 196, 26, 0.3);
        }
        
        .level-good { 
            background: linear-gradient(135deg, #e6f7ff, #bae7ff); 
            color: #1890ff; 
            border: 2px solid rgba(24, 144, 255, 0.3);
        }
        
        .level-medium { 
            background: linear-gradient(135deg, #fff7e6, #ffd591); 
            color: #fa8c16; 
            border: 2px solid rgba(250, 140, 22, 0.3);
        }
        
        .level-poor { 
            background: linear-gradient(135deg, #fff2f0, #ffccc7); 
            color: #ff4d4f; 
            border: 2px solid rgba(255, 77, 79, 0.3);
        }
        
        /* ===============================================
           å®šä½ç±»å‹æ ‡ç­¾
           =============================================== */
        .location-type-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #1890ff, #40a9ff);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(24, 144, 255, 0.3);
        }
        
        /* ===============================================
           å“åº”å¼è®¾è®¡
           =============================================== */
        @media (max-width: 768px) {
            .container {
                padding: 25px;
                margin: 10px;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .location-button {
                min-width: 100%;
                padding: 16px 30px;
                font-size: 16px;
            }
            
            .info-label {
                min-width: 100px;
                font-size: 14px;
            }
            
            .location-method {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .method-icon {
                margin: 0 auto;
            }
        }
        
        /* ===============================================
           åŠ¨ç”»æ•ˆæœ
           =============================================== */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .bounce-in {
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ é«˜å¾·æ™ºèƒ½è¶…ç²¾å‡†å®šä½ç³»ç»Ÿ</h1>
        
        <div class="location-info-card fade-in">
            <div class="location-method">
                <div class="method-icon">ğŸ›°ï¸</div>
                <div class="method-info">
                    <div class="method-title">è¶…ç²¾å‡†æ··åˆå®šä½æŠ€æœ¯</div>
                    <div class="method-desc">
                        é«˜å¾·åœ°å›¾JS API 2.0 + GPSå«æ˜Ÿ + WiFiçƒ­ç‚¹ + åŸºç«™ä¸‰è§’å®šä½ + IPæ™ºèƒ½å®šä½<br>
                        ğŸ“± å®Œç¾æ”¯æŒï¼šå®‰å“/è‹¹æœæ‰‹æœºã€å¹³æ¿ã€ç”µè„‘ | ğŸ”’ éœ€è¦å®šä½æƒé™
                    </div>
                </div>
            </div>
            
            <div id="browserTip" class="info-item" style="margin-top: 15px; padding: 10px; background: rgba(250, 140, 22, 0.1); border-radius: 8px; border-left: 3px solid #fa8c16;">
                <div class="info-label">ğŸ’¡ å®šä½ç²¾åº¦æç¤º:</div>
                <div class="info-value" id="browserTipText">æ­£åœ¨æ£€æµ‹æµè§ˆå™¨ç¯å¢ƒ...</div>
            </div>
        </div>
        
        <button id="locationBtn" class="location-button">
            ğŸš€ å¯åŠ¨è¶…ç²¾å‡†å®šä½
        </button>
        
        <button id="multiSampleBtn" class="location-button" style="background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%); margin-top: 10px;">
            ğŸ¯ å¤šæ¬¡é‡‡æ ·ç²¾å‡†å®šä½ (5æ¬¡é‡‡æ ·)
        </button>
        
        <!-- å®šä½åå·®è¯´æ˜å¡ç‰‡ -->
        <div class="location-info-card fade-in" style="margin-top: 20px; background: linear-gradient(135deg, #fff2f0 0%, #ffebe6 100%);">
            <div style="text-align: center; margin-bottom: 15px;">
                <h3 style="color: #ff4d4f; margin: 0;">âš ï¸ æµè§ˆå™¨å®šä½ç²¾åº¦è¯´æ˜</h3>
            </div>
            
            <div class="info-item" style="border-bottom: 1px solid rgba(255,77,79,0.1); margin: 10px 0; padding-bottom: 10px;">
                <div class="info-label">ğŸ¯ å®æµ‹åå·®:</div>
                <div class="info-value">560ç±³è¥¿åŒ—æ–¹å‘ (ä¸æ‚¨çš„æµ‹è¯•ç»“æœä¸€è‡´)</div>
            </div>
            
            <div class="info-item" style="border-bottom: 1px solid rgba(255,77,79,0.1); margin: 10px 0; padding-bottom: 10px;">
                <div class="info-label">ğŸ” åå·®åŸå› :</div>
                <div class="info-value">
                    â€¢ ç§»åŠ¨ç«¯æµè§ˆå™¨å®‰å…¨é™åˆ¶<br>
                    â€¢ GPSä¿¡å·åå°„å’Œé®æŒ¡<br>
                    â€¢ åŸºç«™è¾…åŠ©å®šä½åå·®<br>
                    â€¢ é«˜å¾·JS APIå®é™…è°ƒç”¨HTML5æ¥å£
                </div>
            </div>
            
            <div class="info-item" style="margin: 10px 0;">
                <div class="info-label">ğŸš€ æå‡æ–¹æ¡ˆ:</div>
                <div class="info-value">
                    <strong>ğŸ’¡ æ¨èæ–¹æ¡ˆæ’åºï¼š</strong><br>
                    1ï¸âƒ£ <strong>å¾®ä¿¡å…¬ä¼—å·JSSDK</strong> (5-30ç±³ç²¾åº¦)<br>
                    2ï¸âƒ£ <strong>åŸç”ŸAPPå¼€å‘</strong> (3-15ç±³ç²¾åº¦)<br>
                    3ï¸âƒ£ <strong>å¤šæ¬¡é‡‡æ ·ç®—æ³•ä¼˜åŒ–</strong> (æ”¹è¿›20-50%)<br>
                    4ï¸âƒ£ <strong>ç”¨æˆ·æ‰‹åŠ¨ä¿®æ­£</strong> (äººå·¥è¾…åŠ©)
                </div>
            </div>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <div id="coordinates" class="info-card coordinates-card fade-in" style="display: none;"></div>
        
        <div id="accuracy" class="info-card accuracy-card fade-in" style="display: none;"></div>
        
        <div id="addressInfo" class="info-card address-card fade-in" style="display: none;"></div>
    </div>

    <script>
        // é«˜å¾·åœ°å›¾APIå¯†é’¥
        const AMAP_KEY = 'dcfb48c0f9cb749e59c5031e83cb6e95';
        
        // DOMå…ƒç´ å¼•ç”¨
        const locationBtn = document.getElementById('locationBtn');
        const multiSampleBtn = document.getElementById('multiSampleBtn');
        const statusDiv = document.getElementById('status');
        const coordinatesDiv = document.getElementById('coordinates');
        const accuracyDiv = document.getElementById('accuracy');
        const addressInfoDiv = document.getElementById('addressInfo');

        // å…¨å±€å˜é‡
        let geolocation = null;

        // çŠ¶æ€æ˜¾ç¤ºå‡½æ•°
        function showStatus(message, type = 'loading') {
            statusDiv.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                ${type === 'loading' ? '<div style="width: 20px; height: 20px; border: 2px solid #1890ff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>' : ''}
                <span>${message}</span>
            </div>`;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            // æ·»åŠ æ—‹è½¬åŠ¨ç”»CSS
            if (type === 'loading') {
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function hideStatus() {
            statusDiv.style.display = 'none';
        }

        // æ˜¾ç¤ºåæ ‡ä¿¡æ¯
        function showCoordinates(latitude, longitude, accuracy, timestamp, locationType = '', info = {}) {
            const date = new Date(timestamp);
            
            coordinatesDiv.innerHTML = `
                <h3>ğŸ“ ç²¾ç¡®ä½ç½®åæ ‡</h3>
                
                <div class="info-item">
                    <div class="info-label">ğŸŒ çº¬åº¦:</div>
                    <div class="info-value">${latitude.toFixed(8)}Â°</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">ğŸŒ ç»åº¦:</div>
                    <div class="info-value">${longitude.toFixed(8)}Â°</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">ğŸ¯ ç²¾åº¦èŒƒå›´:</div>
                    <div class="info-value">Â±${Math.round(accuracy)}ç±³</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">â° å®šä½æ—¶é—´:</div>
                    <div class="info-value">${date.toLocaleString()}</div>
                </div>
                
                ${locationType ? `
                <div class="info-item">
                    <div class="info-label">ğŸ“¡ å®šä½æ–¹å¼:</div>
                    <div class="info-value">
                        <span class="location-type-tag">${locationType}</span>
                    </div>
                </div>
                ` : ''}
                
                <div class="info-item">
                    <div class="info-label">ğŸ”§ åæ ‡ç³»ç»Ÿ:</div>
                    <div class="info-value">
                        <span class="location-type-tag">
                            ${info.isConverted ? 'GCJ-02 (é«˜å¾·åæ ‡ç³»)' : 'WGS-84 (åŸå§‹åæ ‡ç³»)'}
                        </span>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">ğŸ”— æ•°æ®å…¼å®¹æ€§:</div>
                    <div class="info-value">âœ… ä¸é€†åœ°ç†ç¼–ç APIå®Œå…¨å…¼å®¹</div>
                </div>
                
                ${info.isOptimized ? `
                <div class="info-item">
                    <div class="info-label">ğŸ§  ä¼˜åŒ–ç®—æ³•:</div>
                    <div class="info-value">
                        <span class="location-type-tag">å¤šæ¬¡é‡‡æ ·æ™ºèƒ½ä¼˜åŒ–</span>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">ğŸ¯ ä¼˜åŒ–ç½®ä¿¡åº¦:</div>
                    <div class="info-value">${(info.confidence * 100).toFixed(1)}%</div>
                </div>
                ` : ''}
            `;
            coordinatesDiv.style.display = 'block';
            coordinatesDiv.classList.add('bounce-in');
        }

        // æ˜¾ç¤ºç²¾åº¦è¯„ä¼°
        function showAccuracyInfo(accuracy, info = {}) {
            let level, levelClass, description, recommendations;
            
            if (accuracy <= 10) {
                level = 'ğŸŸ¢ æé«˜ç²¾åº¦';
                levelClass = 'level-excellent';
                description = 'GPSçº§åˆ«ç²¾åº¦ï¼Œè¯¯å·®æå°';
                recommendations = 'é€‚åˆï¼šç²¾ç¡®å¯¼èˆªã€æµ‹é‡ã€å®šä½æ‰“å¡';
            } else if (accuracy <= 50) {
                level = 'ğŸ”µ é«˜ç²¾åº¦';
                levelClass = 'level-good';
                description = 'åŸå¸‚å¯¼èˆªçº§åˆ«ï¼Œè¯¯å·®å¾ˆå°';
                recommendations = 'é€‚åˆï¼šæ­¥è¡Œå¯¼èˆªã€å‘¨è¾¹æœç´¢ã€ä½ç½®åˆ†äº«';
            } else if (accuracy <= 200) {
                level = 'ğŸŸ¡ ä¸­ç­‰ç²¾åº¦';
                levelClass = 'level-medium';
                description = 'åŒºåŸŸå®šä½çº§åˆ«ï¼Œä¸€èˆ¬ä½¿ç”¨';
                recommendations = 'é€‚åˆï¼šå¤§è‡´ä½ç½®ç¡®è®¤ã€åŒºåŸŸæœåŠ¡';
            } else if (accuracy <= 1000) {
                level = 'ğŸŸ  ä½ç²¾åº¦';
                levelClass = 'level-medium';
                description = 'å¤§è‡´åŒºåŸŸï¼Œéœ€è¦è¿›ä¸€æ­¥ç¡®è®¤';
                recommendations = 'å»ºè®®ï¼šé‡æ–°å®šä½æˆ–æ‰‹åŠ¨è¾“å…¥è¯¦ç»†ä½ç½®';
            } else {
                level = 'ğŸ”´ å¾ˆä½ç²¾åº¦';
                levelClass = 'level-poor';
                description = 'ä»…ä¾›å‚è€ƒï¼Œå»ºè®®é‡æ–°å®šä½';
                recommendations = 'å»ºè®®ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œå¼€å¯GPSï¼Œé‡æ–°å®šä½';
            }

            accuracyDiv.innerHTML = `
                <h3>ğŸ¯ å®šä½ç²¾åº¦è¯„ä¼°</h3>
                
                <div class="info-item">
                    <div class="info-label">ğŸ“Š ç²¾åº¦ç­‰çº§:</div>
                    <div class="info-value">
                        <span class="accuracy-level ${levelClass}">${level}</span>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">ğŸ“ ç²¾åº¦æè¿°:</div>
                    <div class="info-value">${description}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">ğŸ“ è¯¯å·®èŒƒå›´:</div>
                    <div class="info-value">åœ¨åŠå¾„ ${Math.round(accuracy)} ç±³çš„åœ†åœˆå†…</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">ğŸ’¡ ä½¿ç”¨å»ºè®®:</div>
                    <div class="info-value">${recommendations}</div>
                </div>
                
                ${info.message ? `
                <div class="info-item">
                    <div class="info-label">â„¹ï¸ è¯¦ç»†ä¿¡æ¯:</div>
                    <div class="info-value">${info.message}</div>
                </div>
                ` : ''}
            `;
            accuracyDiv.style.display = 'block';
            accuracyDiv.classList.add('bounce-in');
        }

        // é«˜å¾·é€†åœ°ç†ç¼–ç API
        async function reverseGeocode(longitude, latitude) {
            try {
                // ğŸ” åæ ‡å‚æ•°éªŒè¯
                if (!longitude || !latitude || 
                    typeof longitude !== 'number' || typeof latitude !== 'number' ||
                    latitude < -90 || latitude > 90 || 
                    longitude < -180 || longitude > 180) {
                    throw new Error('ä¼ å…¥çš„åæ ‡å‚æ•°æ— æ•ˆ');
                }
                
                console.log('ğŸ”„ é€†åœ°ç†ç¼–ç è¯·æ±‚å‚æ•°:');
                console.log(`ğŸ“ è¯·æ±‚åæ ‡: location=${longitude},${latitude}`);
                console.log(`ğŸ¯ åæ ‡ç³»ç»Ÿ: GCJ-02 (é«˜å¾·åæ ‡ç³»)`);
                
                showStatus('ğŸ” æ­£åœ¨è§£æè¯¦ç»†åœ°å€ä¿¡æ¯...', 'loading');
                
                const url = `https://restapi.amap.com/v3/geocode/regeo?` +
                    `location=${longitude},${latitude}&` +
                    `key=${AMAP_KEY}&` +
                    `radius=1000&` +
                    `extensions=all&` +
                    `output=json`;
                
                console.log('ğŸ“¡ APIè¯·æ±‚URL:', url);

                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const data = await response.json();
                
                console.log('âœ… é€†åœ°ç†ç¼–ç å“åº”:', data);
                
                if (data.status === '1' && data.regeocode) {
                    console.log('ğŸ‰ åœ°å€è§£ææˆåŠŸ:', data.regeocode.formatted_address);
                    showAddressInfo(data.regeocode);
                    hideStatus();
                } else {
                    console.error('âŒ åœ°å€è§£æå¤±è´¥:', data);
                    throw new Error(data.info || 'åœ°å€è§£æå¤±è´¥');
                }
            } catch (error) {
                console.error('é€†åœ°ç†ç¼–ç å¤±è´¥:', error);
                showStatus(`âŒ åœ°å€è§£æå¤±è´¥: ${error.message}`, 'error');
                setTimeout(hideStatus, 3000);
            }
        }

        // æ˜¾ç¤ºåœ°å€ä¿¡æ¯
        function showAddressInfo(regeocode) {
            const addressComponent = regeocode.addressComponent;
            const pois = regeocode.pois || [];
            const roads = regeocode.roads || [];
            
            let html = `
                <h3>ğŸ  è¯¦ç»†åœ°å€ä¿¡æ¯</h3>
                
                <div class="info-item">
                    <div class="info-label">ğŸ˜ï¸ å®Œæ•´åœ°å€:</div>
                    <div class="info-value">${regeocode.formatted_address || 'æ— '}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">ğŸ“ çœä»½:</div>
                    <div class="info-value">${addressComponent.province || 'æ— '}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">ğŸ™ï¸ åŸå¸‚:</div>
                    <div class="info-value">${addressComponent.city || addressComponent.province || 'æ— '}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">ğŸ˜ï¸ åŒºå¿:</div>
                    <div class="info-value">${addressComponent.district || 'æ— '}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">ğŸ›£ï¸ è¡—é“:</div>
                    <div class="info-value">${addressComponent.township || 'æ— '}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">ğŸ˜ï¸ ç¤¾åŒº:</div>
                    <div class="info-value">${addressComponent.neighborhood?.name || 'æ— '}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">ğŸ¢ å»ºç­‘:</div>
                    <div class="info-value">${addressComponent.building?.name || 'æ— '}</div>
                </div>
            `;

            // æ˜¾ç¤ºé™„è¿‘é“è·¯
            if (roads.length > 0) {
                html += `
                    <div style="margin: 20px 0; padding: 15px; background: rgba(24, 144, 255, 0.05); border-radius: 10px;">
                        <h4 style="margin: 0 0 10px 0; color: #1890ff;">ğŸ›£ï¸ é™„è¿‘é“è·¯</h4>
                `;
                roads.slice(0, 3).forEach((road, index) => {
                    html += `
                        <div class="info-item" style="border-bottom: ${index === Math.min(roads.length, 3) - 1 ? 'none' : '1px solid rgba(0,0,0,0.05)'};">
                            <div class="info-label">ğŸ›¤ï¸ é“è·¯${index + 1}:</div>
                            <div class="info-value">${road.name} (${road.distance}ç±³)</div>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // æ˜¾ç¤ºé™„è¿‘POI
            if (pois.length > 0) {
                html += `
                    <div style="margin: 20px 0; padding: 15px; background: rgba(82, 196, 26, 0.05); border-radius: 10px;">
                        <h4 style="margin: 0 0 10px 0; color: #52c41a;">ğŸ“ é™„è¿‘åœ°æ ‡</h4>
                `;
                pois.slice(0, 5).forEach((poi, index) => {
                    const icon = getPoiIcon(poi.type);
                    html += `
                        <div class="info-item" style="border-bottom: ${index === Math.min(pois.length, 5) - 1 ? 'none' : '1px solid rgba(0,0,0,0.05)'};">
                            <div class="info-label">${icon} ${poi.type}:</div>
                            <div class="info-value">${poi.name} (${poi.distance}ç±³)</div>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            addressInfoDiv.innerHTML = html;
            addressInfoDiv.style.display = 'block';
            addressInfoDiv.classList.add('bounce-in');
        }

        // POIå›¾æ ‡æ˜ å°„
        function getPoiIcon(type) {
            const iconMap = {
                'é¤é¥®æœåŠ¡': 'ğŸ½ï¸',
                'è´­ç‰©æœåŠ¡': 'ğŸ›ï¸',
                'ä½å®¿æœåŠ¡': 'ğŸ¨',
                'ç”Ÿæ´»æœåŠ¡': 'ğŸª',
                'åŒ»ç–—ä¿å¥': 'ğŸ¥',
                'äº¤é€šè®¾æ–½': 'ğŸš‡',
                'é‡‘èä¿é™©': 'ğŸ¦',
                'æ•™è‚²æ–‡åŒ–': 'ğŸ«',
                'å•†åŠ¡ä½å®…': 'ğŸ¢',
                'æ”¿åºœæœºæ„': 'ğŸ›ï¸',
                'æ—…æ¸¸æ™¯ç‚¹': 'ğŸ¡',
                'ä½“è‚²ä¼‘é—²': 'âš½',
                'å…¬å¸ä¼ä¸š': 'ğŸ¢'
            };
            
            for (const [key, icon] of Object.entries(iconMap)) {
                if (type.includes(key)) return icon;
            }
            return 'ğŸ“';
        }

        // è·å–å®šä½ç±»å‹æè¿°
        function getLocationTypeDescription(info) {
            if (info.isConverted) {
                return 'ğŸ¯ é«˜å¾·æ™ºèƒ½æ··åˆå®šä½';
            }
            
            // æ ¹æ®é«˜å¾·æ–‡æ¡£çš„å®šä½ç±»å‹
            const typeMap = {
                'ip': 'ğŸŒ IPç½‘ç»œå®šä½',
                'html5': 'ğŸ“± HTML5æµè§ˆå™¨å®šä½',
                'gps': 'ğŸ›°ï¸ GPSå«æ˜Ÿå®šä½',
                'cell': 'ğŸ“¡ åŸºç«™ä¿¡å·å®šä½',
                'wifi': 'ğŸ“¶ WiFiçƒ­ç‚¹å®šä½'
            };
            
            return typeMap[info.type] || 'ğŸ”„ æ™ºèƒ½æ··åˆå®šä½';
        }

        // é«˜å¾·JS APIè¶…ç²¾å‡†å®šä½ä¸»å‡½æ•°
        async function getCurrentLocation() {
            // é‡ç½®ç•Œé¢
            coordinatesDiv.style.display = 'none';
            accuracyDiv.style.display = 'none';
            addressInfoDiv.style.display = 'none';
            
            locationBtn.disabled = true;
            locationBtn.textContent = 'ğŸ”„ è¶…ç²¾å‡†å®šä½ä¸­...';
            showStatus('ğŸ›°ï¸ æ­£åœ¨å¯åŠ¨é«˜å¾·è¶…ç²¾å‡†å®šä½ç³»ç»Ÿ...', 'loading');

            try {
                // æ£€æŸ¥AMapæ˜¯å¦å·²åŠ è½½
                if (typeof AMap === 'undefined') {
                    throw new Error('é«˜å¾·åœ°å›¾APIæœªæ­£ç¡®åŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }

                // åŠ è½½å®šä½æ’ä»¶
                AMap.plugin('AMap.Geolocation', function() {
                    showStatus('ğŸ¯ é…ç½®è¶…é«˜ç²¾åº¦å®šä½å‚æ•°...', 'loading');
                    
                    // åˆ›å»ºè¶…ç²¾å‡†å®šä½å®ä¾‹ - æ ¹æ®å®˜æ–¹æ–‡æ¡£é…ç½®æœ€é«˜ç²¾åº¦
                    geolocation = new AMap.Geolocation({
                        enableHighAccuracy: true,     // å¯ç”¨é«˜ç²¾åº¦å®šä½ - æœ€é‡è¦çš„å‚æ•°
                        timeout: 30000,               // å¢åŠ è¶…æ—¶æ—¶é—´åˆ°30ç§’ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿæ—¶é—´è·å–GPS
                        maximumAge: 0,                // å¼ºåˆ¶ä¸ä½¿ç”¨ç¼“å­˜ï¼Œæ¯æ¬¡éƒ½è·å–æœ€æ–°ä½ç½®
                        convert: true,                // è‡ªåŠ¨åæ ‡è½¬æ¢ä¸ºé«˜å¾·åæ ‡ç³»
                        showButton: false,            // ä¸æ˜¾ç¤ºåœ°å›¾ä¸Šçš„å®šä½æŒ‰é’®
                        showMarker: false,            // ä¸åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºæ ‡è®°
                        showCircle: false,            // ä¸æ˜¾ç¤ºç²¾åº¦åœ†åœˆ
                        panToLocation: false,         // ä¸ç§»åŠ¨åœ°å›¾ä¸­å¿ƒ
                        zoomToAccuracy: false,        // ä¸è°ƒæ•´åœ°å›¾ç¼©æ”¾çº§åˆ«
                        buttonDom: null,              // ä¸ç»‘å®šDOMæŒ‰é’®
                        noIpLocate: false,            // å…è®¸IPå®šä½ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                        noGeoLocation: false,         // å…è®¸æµè§ˆå™¨å®šä½
                        useNative: true,              // åœ¨ç§»åŠ¨ç«¯å°½é‡ä½¿ç”¨åŸç”Ÿå®šä½èƒ½åŠ›
                        getCityWhenFail: true,        // å®šä½å¤±è´¥æ—¶è¿”å›åŸå¸‚çº§åˆ«ä¿¡æ¯
                        needAddress: true,            // éœ€è¦è·å–åœ°å€ä¿¡æ¯
                        extensions: 'all'             // è¿”å›è¯¦ç»†çš„å®šä½ä¿¡æ¯
                    });

                    showStatus('ğŸ“¡ æ­£åœ¨è¿æ¥GPSå«æ˜Ÿå’Œå®šä½æœåŠ¡...', 'loading');

                    // ç›‘å¬å®šä½æˆåŠŸäº‹ä»¶
                    geolocation.on('complete', async function(result) {
                        console.log('é«˜å¾·è¶…ç²¾å‡†å®šä½æˆåŠŸ:', result);
                        
                        try {
                            // è·å–ä½ç½®ä¿¡æ¯
                            const latitude = result.position.lat;
                            const longitude = result.position.lng;
                            const accuracy = result.accuracy || 50; // å¦‚æœæ²¡æœ‰ç²¾åº¦ä¿¡æ¯ï¼Œé»˜è®¤50ç±³
                            const timestamp = Date.now();
                            
                            // ğŸ” åæ ‡ç³»ç»ŸéªŒè¯
                            console.log('ğŸ¯ åæ ‡ç³»ç»Ÿæ£€æŸ¥:');
                            console.log(`ğŸ“ åŸå§‹åæ ‡: lng=${longitude}, lat=${latitude}`);
                            console.log(`ğŸ”§ åæ ‡ç³»è½¬æ¢: ${result.info?.isConverted ? 'GCJ-02(é«˜å¾·åæ ‡ç³»)' : 'åŸå§‹åæ ‡ç³»'}`);
                            console.log(`ğŸ“¡ å®šä½æ–¹å¼: ${result.info?.type || 'æœªçŸ¥'}`);
                            
                            // åæ ‡åˆç†æ€§æ£€æŸ¥
                            if (!latitude || !longitude || 
                                latitude < -90 || latitude > 90 || 
                                longitude < -180 || longitude > 180) {
                                throw new Error('è·å–åˆ°çš„åæ ‡æ•°æ®å¼‚å¸¸');
                            }
                            
                            // è·å–å®šä½ç±»å‹å’Œè¯¦ç»†ä¿¡æ¯
                            const locationType = getLocationTypeDescription(result.info || {});
                            const locationInfo = result.info || {};
                            
                            showStatus('âœ… å®šä½æˆåŠŸï¼æ­£åœ¨è§£æä½ç½®ä¿¡æ¯...', 'success');
                            
                            // æ˜¾ç¤ºåæ ‡ä¿¡æ¯
                            showCoordinates(latitude, longitude, accuracy, timestamp, locationType, locationInfo);
                            
                            // æ˜¾ç¤ºç²¾åº¦è¯„ä¼°
                            showAccuracyInfo(accuracy, locationInfo);
                            
                            // è°ƒç”¨é€†åœ°ç†ç¼–ç 
                            await reverseGeocode(longitude, latitude);
                            
                            // é‡ç½®æŒ‰é’®
                            locationBtn.disabled = false;
                            locationBtn.textContent = 'ğŸš€ é‡æ–°è¶…ç²¾å‡†å®šä½';
                            
                            showStatus('ğŸ‰ è¶…ç²¾å‡†å®šä½å®Œæˆï¼', 'success');
                            setTimeout(hideStatus, 3000);
                            
                        } catch (error) {
                            console.error('å®šä½åå¤„ç†å¤±è´¥:', error);
                            showStatus(`âŒ å®šä½åå¤„ç†å¤±è´¥: ${error.message}`, 'error');
                            locationBtn.disabled = false;
                            locationBtn.textContent = 'ğŸš€ é‡æ–°å°è¯•å®šä½';
                        }
                    });

                    // ç›‘å¬å®šä½å¤±è´¥äº‹ä»¶
                    geolocation.on('error', function(error) {
                        console.error('é«˜å¾·å®šä½å¤±è´¥:', error);
                        
                        let errorMessage = '';
                        let suggestions = '';
                        
                        switch(error.info) {
                            case 'FAILED':
                                errorMessage = 'å®šä½æœåŠ¡å“åº”å¤±è´¥';
                                suggestions = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œç¨åé‡è¯•';
                                break;
                            case 'NOT_SUPPORTED':
                                errorMessage = 'æµè§ˆå™¨ä¸æ”¯æŒå®šä½åŠŸèƒ½';
                                suggestions = 'è¯·ä½¿ç”¨æ”¯æŒå®šä½çš„ç°ä»£æµè§ˆå™¨';
                                break;
                            case 'NOT_PERMITTED':
                                errorMessage = 'ç”¨æˆ·æ‹’ç»äº†å®šä½æƒé™';
                                suggestions = 'è¯·å…è®¸å®šä½æƒé™ï¼Œç„¶åé‡æ–°å°è¯•';
                                break;
                            case 'POSITION_UNAVAILABLE':
                                errorMessage = 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨';
                                suggestions = 'è¯·ç¡®ä¿GPSå·²å¼€å¯ï¼Œåœ¨å®¤å¤–é‡è¯•';
                                break;
                            case 'TIMEOUT':
                                errorMessage = 'å®šä½è¯·æ±‚è¶…æ—¶';
                                suggestions = 'è¯·ç¡®ä¿ç½‘ç»œç¨³å®šï¼ŒGPSä¿¡å·è‰¯å¥½';
                                break;
                            default:
                                errorMessage = error.message || 'æœªçŸ¥çš„å®šä½é”™è¯¯';
                                suggestions = 'è¯·æ£€æŸ¥è®¾å¤‡è®¾ç½®å’Œç½‘ç»œè¿æ¥';
                                break;
                        }
                        
                        showStatus(`âŒ ${errorMessage}<br><small>ğŸ’¡ ${suggestions}</small>`, 'error');
                        
                        // é‡ç½®æŒ‰é’®
                        locationBtn.disabled = false;
                        locationBtn.textContent = 'ğŸš€ é‡æ–°å°è¯•å®šä½';
                    });

                    showStatus('ğŸ¯ å¼€å§‹è¶…ç²¾å‡†å®šä½ï¼Œè¯·å…è®¸å®šä½æƒé™...', 'loading');
                    
                    // å¼€å§‹å®šä½
                    geolocation.getCurrentPosition();
                });

            } catch (error) {
                console.error('å®šä½ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                showStatus(`âŒ å®šä½ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                
                // é‡ç½®æŒ‰é’®
                locationBtn.disabled = false;
                locationBtn.textContent = 'ğŸš€ é‡æ–°å°è¯•å®šä½';
            }
        }

        // å¤šæ¬¡é‡‡æ ·ç²¾å‡†å®šä½
        async function getMultiSampleLocation() {
            // é‡ç½®ç•Œé¢
            coordinatesDiv.style.display = 'none';
            accuracyDiv.style.display = 'none';
            addressInfoDiv.style.display = 'none';
            
            locationBtn.disabled = true;
            multiSampleBtn.disabled = true;
            multiSampleBtn.textContent = 'ğŸ”„ å¤šæ¬¡é‡‡æ ·ä¸­...';
            
            try {
                if (typeof AMap === 'undefined') {
                    throw new Error('é«˜å¾·åœ°å›¾APIæœªæ­£ç¡®åŠ è½½');
                }

                const samples = [];
                const totalSamples = 5;
                
                for (let i = 0; i < totalSamples; i++) {
                    showStatus(`ğŸ¯ æ­£åœ¨è¿›è¡Œç¬¬ ${i + 1}/${totalSamples} æ¬¡ç²¾å‡†é‡‡æ ·...`, 'loading');
                    
                    try {
                        const sampleResult = await getSingleLocationSample();
                        samples.push(sampleResult);
                        console.log(`ğŸ“ ç¬¬${i + 1}æ¬¡é‡‡æ ·:`, sampleResult);
                        
                        // æ¯æ¬¡é‡‡æ ·åç­‰å¾…2ç§’ï¼Œè®©GPSé‡æ–°å®šä½
                        if (i < totalSamples - 1) {
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                    } catch (error) {
                        console.warn(`ç¬¬${i + 1}æ¬¡é‡‡æ ·å¤±è´¥:`, error);
                    }
                }
                
                if (samples.length === 0) {
                    throw new Error('æ‰€æœ‰é‡‡æ ·å‡å¤±è´¥');
                }
                
                showStatus('ğŸ§  æ­£åœ¨æ™ºèƒ½åˆ†æå¤šæ¬¡é‡‡æ ·æ•°æ®...', 'loading');
                
                // æ™ºèƒ½ç®—æ³•åˆ†æå¤šæ¬¡é‡‡æ ·ç»“æœ
                const optimizedResult = analyzeMultiSamples(samples);
                
                console.log('ğŸ‰ å¤šæ¬¡é‡‡æ ·ä¼˜åŒ–ç»“æœ:', optimizedResult);
                
                // æ˜¾ç¤ºä¼˜åŒ–åçš„ç»“æœ
                await showOptimizedLocationResult(optimizedResult, samples);
                
            } catch (error) {
                console.error('å¤šæ¬¡é‡‡æ ·å®šä½å¤±è´¥:', error);
                showStatus(`âŒ å¤šæ¬¡é‡‡æ ·å¤±è´¥: ${error.message}`, 'error');
            } finally {
                locationBtn.disabled = false;
                multiSampleBtn.disabled = false;
                multiSampleBtn.textContent = 'ğŸ¯ å¤šæ¬¡é‡‡æ ·ç²¾å‡†å®šä½ (5æ¬¡é‡‡æ ·)';
            }
        }

        // è·å–å•æ¬¡å®šä½æ ·æœ¬
        function getSingleLocationSample() {
            return new Promise((resolve, reject) => {
                AMap.plugin('AMap.Geolocation', function() {
                    const tempGeolocation = new AMap.Geolocation({
                        enableHighAccuracy: true,
                        timeout: 8000,
                        maximumAge: 0, // å¼ºåˆ¶ä¸ä½¿ç”¨ç¼“å­˜
                        convert: true,
                        noIpLocate: true, // ç¦ç”¨IPå®šä½ï¼Œå¼ºåˆ¶GPS
                        needAddress: false
                    });

                    tempGeolocation.on('complete', function(result) {
                        resolve({
                            latitude: result.position.lat,
                            longitude: result.position.lng,
                            accuracy: result.accuracy || 100,
                            timestamp: Date.now(),
                            type: result.info?.type || 'unknown'
                        });
                    });

                    tempGeolocation.on('error', function(error) {
                        reject(error);
                    });

                    tempGeolocation.getCurrentPosition();
                });
            });
        }

        // æ™ºèƒ½åˆ†æå¤šæ¬¡é‡‡æ ·æ•°æ®
        function analyzeMultiSamples(samples) {
            if (samples.length === 0) return null;
            
            console.log('ğŸ§  åˆ†æå¤šæ¬¡é‡‡æ ·æ•°æ®:', samples);
            
            // 1. ç§»é™¤å¼‚å¸¸å€¼ (ä½¿ç”¨å››åˆ†ä½æ•°æ³•)
            const validSamples = removeOutliers(samples);
            console.log('âœ… ç§»é™¤å¼‚å¸¸å€¼å:', validSamples);
            
            // 2. åŠ æƒå¹³å‡ (ç²¾åº¦è¶Šé«˜æƒé‡è¶Šå¤§)
            const weightedResult = calculateWeightedAverage(validSamples);
            console.log('âš–ï¸ åŠ æƒå¹³å‡ç»“æœ:', weightedResult);
            
            // 3. è®¡ç®—ç½®ä¿¡åº¦å’Œæ”¹è¿›ç¨‹åº¦
            const confidence = calculateConfidence(validSamples);
            const improvement = calculateImprovement(samples, weightedResult);
            
            return {
                ...weightedResult,
                confidence,
                improvement,
                sampleCount: validSamples.length,
                originalSamples: samples,
                validSamples
            };
        }

        // ç§»é™¤å¼‚å¸¸å€¼
        function removeOutliers(samples) {
            if (samples.length <= 3) return samples;
            
            // è®¡ç®—ç»çº¬åº¦çš„ä¸­ä½æ•°
            const lats = samples.map(s => s.latitude).sort((a, b) => a - b);
            const lngs = samples.map(s => s.longitude).sort((a, b) => a - b);
            
            const medianLat = lats[Math.floor(lats.length / 2)];
            const medianLng = lngs[Math.floor(lngs.length / 2)];
            
            // è®¡ç®—æ¯ä¸ªæ ·æœ¬åˆ°ä¸­ä½æ•°çš„è·ç¦»
            const distances = samples.map(sample => {
                const latDiff = sample.latitude - medianLat;
                const lngDiff = sample.longitude - medianLng;
                return Math.sqrt(latDiff * latDiff + lngDiff * lngDiff);
            });
            
            // ç§»é™¤è·ç¦»è¶…è¿‡1.5å€å››åˆ†ä½è·çš„å¼‚å¸¸å€¼
            const sortedDistances = [...distances].sort((a, b) => a - b);
            const q1 = sortedDistances[Math.floor(sortedDistances.length * 0.25)];
            const q3 = sortedDistances[Math.floor(sortedDistances.length * 0.75)];
            const iqr = q3 - q1;
            const threshold = q3 + 1.5 * iqr;
            
            return samples.filter((sample, index) => distances[index] <= threshold);
        }

        // åŠ æƒå¹³å‡è®¡ç®—
        function calculateWeightedAverage(samples) {
            if (samples.length === 0) return null;
            
            // æƒé‡ = 1 / (ç²¾åº¦ + 10)ï¼Œç²¾åº¦è¶Šé«˜æƒé‡è¶Šå¤§
            const weights = samples.map(s => 1 / (s.accuracy + 10));
            const totalWeight = weights.reduce((sum, w) => sum + w, 0);
            
            const weightedLat = samples.reduce((sum, sample, index) => 
                sum + sample.latitude * weights[index], 0) / totalWeight;
            
            const weightedLng = samples.reduce((sum, sample, index) => 
                sum + sample.longitude * weights[index], 0) / totalWeight;
            
            // ä¼°ç®—æ”¹è¿›åçš„ç²¾åº¦
            const avgAccuracy = samples.reduce((sum, s) => sum + s.accuracy, 0) / samples.length;
            const improvementFactor = Math.min(samples.length * 0.2, 0.7); // æœ€å¤šæ”¹è¿›70%
            const estimatedAccuracy = avgAccuracy * (1 - improvementFactor);
            
            return {
                latitude: weightedLat,
                longitude: weightedLng,
                accuracy: estimatedAccuracy,
                timestamp: Date.now()
            };
        }

        // è®¡ç®—ç½®ä¿¡åº¦
        function calculateConfidence(samples) {
            if (samples.length <= 1) return 0.3;
            
            // åŸºäºæ ·æœ¬æ•°é‡å’Œä¸€è‡´æ€§è®¡ç®—ç½®ä¿¡åº¦
            const baseConfidence = Math.min(samples.length * 0.15, 0.8);
            
            // è®¡ç®—æ ·æœ¬çš„ä¸€è‡´æ€§ (å˜å¼‚ç³»æ•°)
            const lats = samples.map(s => s.latitude);
            const lngs = samples.map(s => s.longitude);
            
            const latStd = calculateStandardDeviation(lats);
            const lngStd = calculateStandardDeviation(lngs);
            const avgStd = (latStd + lngStd) / 2;
            
            const consistencyBonus = Math.max(0, 0.2 - avgStd * 1000); // ä¸€è‡´æ€§è¶Šé«˜å¥–åŠ±è¶Šå¤š
            
            return Math.min(baseConfidence + consistencyBonus, 0.95);
        }

        // è®¡ç®—æ”¹è¿›ç¨‹åº¦
        function calculateImprovement(samples, optimizedResult) {
            if (samples.length === 0) return 0;
            
            const avgOriginalAccuracy = samples.reduce((sum, s) => sum + s.accuracy, 0) / samples.length;
            const improvementRatio = (avgOriginalAccuracy - optimizedResult.accuracy) / avgOriginalAccuracy;
            
            return Math.max(0, Math.min(improvementRatio, 0.8)); // æœ€å¤š80%æ”¹è¿›
        }

        // è®¡ç®—æ ‡å‡†å·®
        function calculateStandardDeviation(values) {
            const avg = values.reduce((sum, val) => sum + val, 0) / values.length;
            const squaredDiffs = values.map(val => Math.pow(val - avg, 2));
            const avgSquaredDiff = squaredDiffs.reduce((sum, diff) => sum + diff, 0) / values.length;
            return Math.sqrt(avgSquaredDiff);
        }

        // æ˜¾ç¤ºä¼˜åŒ–åçš„å®šä½ç»“æœ
        async function showOptimizedLocationResult(result, originalSamples) {
            const locationType = 'ğŸ¯ æ™ºèƒ½å¤šæ¬¡é‡‡æ ·ä¼˜åŒ–å®šä½';
            
            // æ˜¾ç¤ºä¼˜åŒ–åçš„åæ ‡
            showCoordinates(
                result.latitude, 
                result.longitude, 
                result.accuracy, 
                result.timestamp, 
                locationType,
                { isOptimized: true, confidence: result.confidence }
            );
            
            // æ˜¾ç¤ºæ”¹è¿›åˆ†æ
            showImprovementAnalysis(result, originalSamples);
            
            // è°ƒç”¨é€†åœ°ç†ç¼–ç 
            await reverseGeocode(result.longitude, result.latitude);
            
            showStatus('ğŸ‰ å¤šæ¬¡é‡‡æ ·å®šä½ä¼˜åŒ–å®Œæˆï¼', 'success');
            setTimeout(hideStatus, 3000);
        }

        // æ˜¾ç¤ºæ”¹è¿›åˆ†æ
        function showImprovementAnalysis(result, originalSamples) {
            const avgOriginalAccuracy = originalSamples.reduce((sum, s) => sum + s.accuracy, 0) / originalSamples.length;
            const improvementPercent = (result.improvement * 100).toFixed(1);
            const confidencePercent = (result.confidence * 100).toFixed(1);
            
            let levelClass, levelText;
            if (result.confidence >= 0.8) {
                levelClass = 'level-excellent';
                levelText = 'ğŸ† æé«˜ç½®ä¿¡åº¦';
            } else if (result.confidence >= 0.6) {
                levelClass = 'level-good';
                levelText = 'âœ… é«˜ç½®ä¿¡åº¦';
            } else if (result.confidence >= 0.4) {
                levelClass = 'level-medium';
                levelText = 'âš ï¸ ä¸­ç­‰ç½®ä¿¡åº¦';
            } else {
                levelClass = 'level-poor';
                levelText = 'â— ä½ç½®ä¿¡åº¦';
            }

            accuracyDiv.innerHTML = `
                <h3>ğŸ§  æ™ºèƒ½å¤šæ¬¡é‡‡æ ·åˆ†æ</h3>
                
                <div class="info-item">
                    <div class="info-label">ğŸ“Š é‡‡æ ·ç»Ÿè®¡:</div>
                    <div class="info-value">${originalSamples.length}æ¬¡é‡‡æ ·ï¼Œ${result.sampleCount}æ¬¡æœ‰æ•ˆ</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">ğŸ¯ ä¼˜åŒ–æ•ˆæœ:</div>
                    <div class="info-value">
                        ${avgOriginalAccuracy.toFixed(0)}ç±³ â†’ ${result.accuracy.toFixed(0)}ç±³ 
                        (æ”¹è¿›${improvementPercent}%)
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">ğŸ” ç½®ä¿¡åº¦è¯„ä¼°:</div>
                    <div class="info-value">
                        <span class="accuracy-level ${levelClass}">${levelText} (${confidencePercent}%)</span>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">ğŸ“ ä¼°ç®—ç²¾åº¦:</div>
                    <div class="info-value">Â±${result.accuracy.toFixed(0)}ç±³ (æ™ºèƒ½ä¼˜åŒ–å)</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">ğŸ§® ç®—æ³•è¯´æ˜:</div>
                    <div class="info-value">å¼‚å¸¸å€¼è¿‡æ»¤ + ç²¾åº¦åŠ æƒå¹³å‡ + ç½®ä¿¡åº¦åˆ†æ</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">ğŸ’¡ å»ºè®®:</div>
                    <div class="info-value">
                        ${result.confidence >= 0.7 ? 
                            'âœ… ä¼˜åŒ–æ•ˆæœè‰¯å¥½ï¼Œå¯ä¿¡èµ–æ­¤ç»“æœ' : 
                            'âš ï¸ å»ºè®®åœ¨ç©ºæ—·åŒºåŸŸé‡æ–°é‡‡æ ·'}
                    </div>
                </div>
            `;
            accuracyDiv.style.display = 'block';
            accuracyDiv.classList.add('bounce-in');
        }

        // ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        locationBtn.addEventListener('click', getCurrentLocation);
        multiSampleBtn.addEventListener('click', getMultiSampleLocation);

        // æ£€æµ‹æµè§ˆå™¨ç¯å¢ƒ
        function detectBrowserEnvironment() {
            const userAgent = navigator.userAgent;
            const browserTipText = document.getElementById('browserTipText');
            
            let tip = '';
            let expectedAccuracy = '';
            
            if (/micromessenger/i.test(userAgent)) {
                tip = 'ğŸ”¥ å¾®ä¿¡æµè§ˆå™¨ç¯å¢ƒï¼Œå»ºè®®å¼€å‘å¾®ä¿¡å…¬ä¼—å·ä½¿ç”¨JSSDKå®šä½è·å¾—æ›´é«˜ç²¾åº¦ (5-30ç±³)';
                expectedAccuracy = 'å½“å‰é¢„æœŸç²¾åº¦ï¼š50-200ç±³';
            } else if (/mobile/i.test(userAgent)) {
                if (/iphone|ipad/i.test(userAgent)) {
                    tip = 'ğŸ“± iOSè®¾å¤‡ï¼Œå»ºè®®å¼€å¯"ç²¾ç¡®ä½ç½®"æƒé™ã€‚Safariæµè§ˆå™¨å®šä½ç²¾åº¦è¾ƒå¥½';
                    expectedAccuracy = 'å½“å‰é¢„æœŸç²¾åº¦ï¼š10-100ç±³';
                } else if (/android/i.test(userAgent)) {
                    tip = 'ğŸ¤– Androidè®¾å¤‡ï¼Œå»ºè®®åœ¨GPSä¿¡å·è‰¯å¥½çš„å®¤å¤–ä½¿ç”¨';
                    expectedAccuracy = 'å½“å‰é¢„æœŸç²¾åº¦ï¼š15-150ç±³';
                }
            } else {
                tip = 'ğŸ’» ç”µè„‘ç«¯æµè§ˆå™¨ï¼Œå®šä½ç²¾åº¦æœ‰é™ã€‚å»ºè®®ä½¿ç”¨æ‰‹æœºè®¿é—®è·å¾—æ›´å¥½æ•ˆæœ';
                expectedAccuracy = 'å½“å‰é¢„æœŸç²¾åº¦ï¼š100-1000ç±³';
            }
            
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                tip += ' | âš ï¸ å»ºè®®ä½¿ç”¨HTTPSåè®®è®¿é—®';
            }
            
            if (browserTipText) {
                browserTipText.innerHTML = `${tip}<br><small style="color: #666;">${expectedAccuracy}</small>`;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æµ‹æµè§ˆå™¨ç¯å¢ƒ
            detectBrowserEnvironment();
            
            // æ£€æŸ¥é«˜å¾·APIæ˜¯å¦æ­£ç¡®åŠ è½½
            if (typeof AMap === 'undefined') {
                showStatus('âš ï¸ é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                locationBtn.disabled = true;
                multiSampleBtn.disabled = true;
                locationBtn.textContent = 'âŒ APIåŠ è½½å¤±è´¥';
                multiSampleBtn.textContent = 'âŒ APIåŠ è½½å¤±è´¥';
            } else {
                console.log('ğŸ‰ é«˜å¾·åœ°å›¾APIåŠ è½½æˆåŠŸï¼Œè¶…ç²¾å‡†å®šä½ç³»ç»Ÿå°±ç»ª');
                
                // æ£€æŸ¥HTTPS
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    showStatus('âš ï¸ ä¸ºäº†è·å¾—æœ€ä½³å®šä½ç²¾åº¦ï¼Œå»ºè®®ä½¿ç”¨HTTPSåè®®', 'error');
                }
            }
        });
    </script>
</body>
</html>
