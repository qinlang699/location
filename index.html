<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åä½œå®šä½ç³»ç»Ÿ - æ”¯æŒç”µè„‘ç«¯å’Œç§»åŠ¨ç«¯</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        /* ç²¾åº¦ç­‰çº§æŒ‡ç¤ºå™¨ */
        .accuracy-indicator {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .level {
            flex: 1;
            text-align: center;
            padding: 8px;
            margin: 0 5px;
            border-radius: 6px;
            background: #e9ecef;
            color: #6c757d;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .level.active {
            background: #28a745;
            color: white;
            transform: scale(1.05);
        }
        
        .level.target {
            background: #ffc107;
            color: #212529;
        }
        
        .test-button {
            background: #1890ff;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            margin: 20px auto;
            transition: background-color 0.3s;
        }
        
        .test-button:hover {
            background: #40a9ff;
        }
        
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* ä½ç½®ç¡®è®¤ç•Œé¢ */
        .location-confirm {
            background: #e6f7ff;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #91d5ff;
            text-align: center;
        }
        
        .address-big {
            font-size: 18px;
            font-weight: bold;
            color: #1890ff;
            margin: 15px 0;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }
        
        .accuracy-note {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .confirm-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn-yes { background: #52c41a; }
        .btn-no { background: #ff4d4f; }
        .btn-unknown { background: #faad14; }
        
        .btn-yes, .btn-no, .btn-unknown {
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: opacity 0.3s;
        }
        
        .btn-yes:hover, .btn-no:hover, .btn-unknown:hover {
            opacity: 0.8;
        }
        
        /* POIåœ°æ ‡é€‰æ‹© */
        .landmark-selection {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #1890ff;
        }
        
        .landmarks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .landmark-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .landmark-card:hover {
            border-color: #1890ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(24, 144, 255, 0.15);
        }
        
        .landmark-card.selected {
            border-color: #52c41a;
            background: #f6ffed;
        }
        
        .landmark-icon {
            font-size: 24px;
            text-align: center;
            margin-bottom: 8px;
        }
        
        .landmark-card h4 {
            margin: 8px 0;
            color: #333;
            font-size: 16px;
        }
        
        .distance, .time {
            color: #666;
            font-size: 13px;
            margin: 4px 0;
        }
        
        .select-landmark {
            width: 100%;
            background: #1890ff;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }
        
        .select-landmark:hover {
            background: #40a9ff;
        }
        
        .no-landmark {
            text-align: center;
            margin-top: 20px;
        }
        
        .btn-none {
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        /* ç²¾ç¡®ä½ç½®ç¡®å®š */
        .precise-location {
            background: #fff7e6;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #fa8c16;
        }
        
        .direction-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .direction-option {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .direction-option:hover {
            border-color: #fa8c16;
        }
        
        .direction-option.selected {
            border-color: #52c41a;
            background: #f6ffed;
        }
        
        .direction-label {
            font-weight: bold;
            color: #fa8c16;
            margin-bottom: 8px;
        }
        
        .distance-selector {
            margin: 20px 0;
        }
        
        .distance-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .distance-buttons button {
            padding: 8px 16px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .distance-buttons button:hover {
            border-color: #1890ff;
            color: #1890ff;
        }
        
        .distance-buttons button.selected {
            border-color: #52c41a;
            background: #52c41a;
            color: white;
        }
        
        /* è·ç¦»æ„ŸçŸ¥è¾…åŠ© */
        .distance-helper {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 13px;
        }
        
        .distance-helper ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .distance-helper li {
            margin: 5px 0;
        }
        
        /* è¿›åº¦æŒ‡ç¤ºå™¨ */
        .accuracy-progress {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4d4f, #faad14, #52c41a);
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        
        .progress-text {
            color: #52c41a;
            font-weight: bold;
            margin-top: 8px;
        }
        
        /* ç½®ä¿¡åº¦æŒ‡ç¤ºå™¨ */
        .confidence-meter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background: #f6ffed;
            border-radius: 6px;
        }
        
        .confidence-stars {
            color: #faad14;
        }

        /* æ‰‹åŠ¨è¾“å…¥æ ·å¼ */
        .manual-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .manual-input:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .device-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 12px;
            color: #666;
            border-left: 3px solid #1890ff;
        }

        .location-methods {
            display: grid;
            gap: 10px;
            margin: 15px 0;
        }

        .method-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 12px;
        }

        .method-icon {
            margin-right: 8px;
            font-size: 16px;
        }
        
        .status {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .status.loading {
            background: #e6f7ff;
            color: #1890ff;
            border: 1px solid #91d5ff;
        }
        
        .status.success {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        
        .status.error {
            background: #fff2f0;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
        }
        
        .coordinates {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }
        
        .address-info {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #1890ff;
        }
        
        .address-item {
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px dotted #ddd;
        }
        
        .label {
            font-weight: bold;
            color: #333;
            display: inline-block;
            min-width: 100px;
        }
        
        .accuracy-info {
            background: #fff7e6;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #fa8c16;
        }
        
        @media (max-width: 600px) {
            .confirm-buttons {
                flex-direction: column;
            }
            
            .landmarks-grid {
                grid-template-columns: 1fr;
            }
            
            .direction-grid {
                grid-template-columns: 1fr;
            }
            
            .distance-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ æ™ºèƒ½åä½œå®šä½ç³»ç»Ÿ</h1>
        
        <!-- è®¾å¤‡å…¼å®¹æ€§ä¿¡æ¯ -->
        <div id="deviceInfo" class="device-info" style="text-align: center; margin-bottom: 20px;">
            <span id="deviceStatus">ğŸ” æ­£åœ¨æ£€æµ‹è®¾å¤‡å…¼å®¹æ€§...</span>
        </div>
        
        <!-- ç²¾åº¦ç­‰çº§æŒ‡ç¤ºå™¨ -->
        <div class="accuracy-indicator">
            <div class="level" data-level="1">ğŸŒ åŒºåŸŸçº§<br>2000m</div>
            <div class="level" data-level="2">ğŸ˜ï¸ è¡—åŒºçº§<br>1000m</div>
            <div class="level" data-level="3">ğŸª å•†åœˆçº§<br>200m</div>
            <div class="level" data-level="4">ğŸ¯ ç²¾ç¡®çº§<br>50m</div>
        </div>
        
        <!-- ç²¾åº¦è¿›åº¦æŒ‡ç¤ºå™¨ -->
        <div id="accuracyProgress" class="accuracy-progress" style="display: none;">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 25%;"></div>
            </div>
            <div id="progressText" class="progress-text">å¼€å§‹å®šä½...</div>
        </div>
        
        <button id="locationBtn" class="test-button">
            ğŸš€ å¼€å§‹æ™ºèƒ½å®šä½
        </button>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <!-- äººæœºåä½œç•Œé¢å®¹å™¨ -->
        <div id="collaborationInterface" style="display: none;">
            <!-- ä½ç½®ç¡®è®¤ç•Œé¢ -->
            <div id="locationConfirm" class="location-confirm" style="display: none;"></div>
            
            <!-- åœ°æ ‡é€‰æ‹©ç•Œé¢ -->
            <div id="landmarkSelection" class="landmark-selection" style="display: none;"></div>
            
            <!-- ç²¾ç¡®ä½ç½®ç¡®å®šç•Œé¢ -->
            <div id="preciseLocation" class="precise-location" style="display: none;"></div>
        </div>
        
        <div id="coordinates" class="coordinates" style="display: none;"></div>
        
        <div id="accuracy" class="accuracy-info" style="display: none;"></div>
        
        <div id="addressInfo" class="address-info" style="display: none;"></div>
    </div>

    <script>
        // é«˜å¾·åœ°å›¾APIå¯†é’¥
        const AMAP_KEY = 'dcfb48c0f9cb749e59c5031e83cb6e95';
        
        // DOMå…ƒç´ å¼•ç”¨
        const locationBtn = document.getElementById('locationBtn');
        const statusDiv = document.getElementById('status');
        const coordinatesDiv = document.getElementById('coordinates');
        const accuracyDiv = document.getElementById('accuracy');
        const addressInfoDiv = document.getElementById('addressInfo');
        const collaborationInterface = document.getElementById('collaborationInterface');
        const locationConfirm = document.getElementById('locationConfirm');
        const landmarkSelection = document.getElementById('landmarkSelection');
        const preciseLocation = document.getElementById('preciseLocation');
        const accuracyProgress = document.getElementById('accuracyProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');

        // å…¨å±€çŠ¶æ€ç®¡ç†
        let currentLocationData = {
            latitude: null,
            longitude: null,
            accuracy: null,
            timestamp: null,
            address: null,
            accuracyLevel: 1,
            selectedPoi: null,
            finalLocation: null
        };

        // ç²¾åº¦ç­‰çº§å®šä¹‰ (è°ƒæ•´æœç´¢åŠå¾„)
        const ACCURACY_LEVELS = {
            1: { name: 'åŒºåŸŸçº§', radius: 2000, progress: 25 },    // å¢åŠ åˆ°2km
            2: { name: 'è¡—åŒºçº§', radius: 1000, progress: 50 },   // å¢åŠ åˆ°1km  
            3: { name: 'å•†åœˆçº§', radius: 200, progress: 75 },    // ä¿æŒ200m
            4: { name: 'ç²¾ç¡®çº§', radius: 50, progress: 100 }     // ä¿æŒ50m
        };

        // POIç±»å‹æ˜ å°„å’Œå›¾æ ‡
        const POI_ICONS = {
            'è´­ç‰©æœåŠ¡': 'ğŸ›ï¸',
            'é¤é¥®æœåŠ¡': 'ğŸ½ï¸',
            'ä½å®¿æœåŠ¡': 'ğŸ¨',
            'ç”Ÿæ´»æœåŠ¡': 'ğŸª',
            'åŒ»ç–—ä¿å¥': 'ğŸ¥',
            'äº¤é€šè®¾æ–½': 'ğŸš‡',
            'é‡‘èä¿é™©': 'ğŸ¦',
            'æ•™è‚²æ–‡åŒ–': 'ğŸ«',
            'å•†åŠ¡ä½å®…': 'ğŸ¢',
            'æ”¿åºœæœºæ„': 'ğŸ›ï¸',
            'æ—…æ¸¸æ™¯ç‚¹': 'ğŸ›ï¸',
            'ä½“è‚²ä¼‘é—²': 'âš½',
            'å…¬å¸ä¼ä¸š': 'ğŸ¢',
            'é“è·¯é™„å±': 'ğŸ›£ï¸',
            'åœ°ååœ°å€': 'ğŸ“',
            'å…¬å…±è®¾æ–½': 'ğŸ¢'
        };

        // è®¾å¤‡æ£€æµ‹å’Œå…¼å®¹æ€§å·¥å…·å‡½æ•°
        function detectDevice() {
            const userAgent = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            const isDesktop = !isMobile;
            const hasGPS = 'geolocation' in navigator;
            
            return {
                isMobile,
                isDesktop,
                hasGPS,
                platform: isMobile ? 'mobile' : 'desktop',
                userAgent
            };
        }

        // IPå®šä½API (é™çº§æ–¹æ¡ˆ)
        async function getLocationByIP() {
            try {
                showStatus('ğŸŒ ä½¿ç”¨IPå®šä½ï¼Œç²¾åº¦è¾ƒä½...', 'loading');
                
                // ä½¿ç”¨é«˜å¾·IPå®šä½API
                const url = `https://restapi.amap.com/v3/ip?key=${AMAP_KEY}&output=json`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`IPå®šä½HTTPé”™è¯¯: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.status === '1' && data.rectangle) {
                    // è§£æçŸ©å½¢åŒºåŸŸï¼Œå–ä¸­å¿ƒç‚¹
                    const coords = data.rectangle.split(';');
                    const [lon1, lat1] = coords[0].split(',').map(Number);
                    const [lon2, lat2] = coords[1].split(',').map(Number);
                    
                    const centerLon = (lon1 + lon2) / 2;
                    const centerLat = (lat1 + lat2) / 2;
                    
                    return {
                        latitude: centerLat,
                        longitude: centerLon,
                        accuracy: 5000, // IPå®šä½ç²¾åº¦é€šå¸¸åœ¨5kmå·¦å³
                        timestamp: Date.now(),
                        method: 'ip_location',
                        city: data.city || 'æœªçŸ¥åŸå¸‚',
                        province: data.province || 'æœªçŸ¥çœä»½'
                    };
                } else {
                    throw new Error(data.info || 'IPå®šä½å¤±è´¥');
                }
            } catch (error) {
                console.error('IPå®šä½å¤±è´¥:', error);
                throw error;
            }
        }

        // æ‰‹åŠ¨è¾“å…¥ä½ç½®
        function showManualLocationInput() {
            const device = detectDevice();
            
            const manualInputHtml = `
                <div class="location-confirm">
                    <h2>ğŸ“ æ‰‹åŠ¨è¾“å…¥ä½ç½®</h2>
                    
                    <div class="device-info">
                        ğŸ–¥ï¸ å½“å‰è®¾å¤‡ï¼š${device.platform === 'desktop' ? 'ç”µè„‘ç«¯' : 'ç§»åŠ¨ç«¯'} | 
                        æ‰‹åŠ¨è¾“å…¥å¯ä»¥è·å¾—æœ€å‡†ç¡®çš„å®šä½ç»“æœ
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <input type="text" id="manualAddress" class="manual-input"
                               placeholder="è¯·è¾“å…¥æ‚¨å½“å‰çš„ä½ç½®..."
                               onkeypress="if(event.key==='Enter') searchManualLocation()">
                    </div>
                    
                    <div class="location-methods">
                        <div class="method-item">
                            <span class="method-icon">ğŸ¢</span>
                            <span>å•†åœº/å»ºç­‘ï¼šå¦‚"é“¶æ³°åŸ"ã€"å›½è´¸å¤§å¦"</span>
                        </div>
                        <div class="method-item">
                            <span class="method-icon">ğŸ™ï¸</span>
                            <span>å•†åœˆ/åœ°åŒºï¼šå¦‚"ä¸‰é‡Œå±¯"ã€"ä¸­å…³æ‘"</span>
                        </div>
                        <div class="method-item">
                            <span class="method-icon">ğŸ“</span>
                            <span>è¯¦ç»†åœ°å€ï¼šå¦‚"åŒ—äº¬å¸‚æœé˜³åŒºæœ›äº¬è¡—é“"</span>
                        </div>
                        <div class="method-item">
                            <span class="method-icon">ğŸš‡</span>
                            <span>åœ°é“ç«™ç‚¹ï¼šå¦‚"æœ›äº¬è¥¿ç«™"ã€"å›½è´¸ç«™"</span>
                        </div>
                    </div>
                    
                    <div class="confirm-buttons">
                        <button class="btn-yes" onclick="searchManualLocation()">ğŸ” æœç´¢æ­¤ä½ç½®</button>
                        <button class="btn-unknown" onclick="showQuickLocationOptions()">âš¡ å¿«é€Ÿé€‰æ‹©</button>
                        <button class="btn-no" onclick="restartLocation()">ğŸ”™ è¿”å›é‡è¯•</button>
                    </div>
                </div>
            `;
            
            locationConfirm.innerHTML = manualInputHtml;
            locationConfirm.style.display = 'block';
            collaborationInterface.style.display = 'block';
            
            // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
            setTimeout(() => {
                const input = document.getElementById('manualAddress');
                if (input) input.focus();
            }, 100);
        }

        // æ˜¾ç¤ºå¿«é€Ÿä½ç½®é€‰æ‹©
        function showQuickLocationOptions() {
            const quickOptions = [
                { name: 'åŒ—äº¬å¸‚ä¸­å¿ƒ', address: 'åŒ—äº¬å¸‚ä¸œåŸåŒºç‹åºœäº•å¤§è¡—' },
                { name: 'ä¸Šæµ·å¸‚ä¸­å¿ƒ', address: 'ä¸Šæµ·å¸‚é»„æµ¦åŒºå—äº¬ä¸œè·¯' },
                { name: 'å¹¿å·å¸‚ä¸­å¿ƒ', address: 'å¹¿å·å¸‚å¤©æ²³åŒºç æ±Ÿæ–°åŸ' },
                { name: 'æ·±åœ³å¸‚ä¸­å¿ƒ', address: 'æ·±åœ³å¸‚ç¦ç”°åŒºåå¼ºåŒ—' },
                { name: 'æ­å·å¸‚ä¸­å¿ƒ', address: 'æ­å·å¸‚è¥¿æ¹–åŒºè¥¿æ¹–' },
                { name: 'æˆéƒ½å¸‚ä¸­å¿ƒ', address: 'æˆéƒ½å¸‚é”¦æ±ŸåŒºæ˜¥ç†™è·¯' }
            ];
            
            const quickHtml = `
                <div class="location-confirm">
                    <h2>âš¡ å¿«é€Ÿé€‰æ‹©å¸¸ç”¨ä½ç½®</h2>
                    
                    <div class="landmarks-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        ${quickOptions.map(option => `
                            <div class="landmark-card" onclick="selectQuickLocation('${option.address}', '${option.name}')" style="cursor: pointer;">
                                <div class="landmark-icon">ğŸ™ï¸</div>
                                <h4>${option.name}</h4>
                                <div style="font-size: 12px; color: #666;">${option.address}</div>
                                <button class="select-landmark">é€‰æ‹©æ­¤ä½ç½®</button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn-unknown" onclick="showManualLocationInput()">âœï¸ æ‰‹åŠ¨è¾“å…¥å…¶ä»–ä½ç½®</button>
                        <button class="btn-no" onclick="restartLocation()" style="margin-left: 10px;">ğŸ”™ è¿”å›</button>
                    </div>
                </div>
            `;
            
            locationConfirm.innerHTML = quickHtml;
        }

        // é€‰æ‹©å¿«é€Ÿä½ç½®
        async function selectQuickLocation(address, name) {
            document.getElementById('manualAddress') || showManualLocationInput();
            setTimeout(() => {
                const input = document.getElementById('manualAddress');
                if (input) {
                    input.value = address;
                    searchManualLocation();
                }
            }, 100);
        }

        // æœç´¢æ‰‹åŠ¨è¾“å…¥çš„ä½ç½®
        async function searchManualLocation() {
            const address = document.getElementById('manualAddress').value.trim();
            if (!address) {
                showStatus('âš ï¸ è¯·è¾“å…¥ä½ç½®ä¿¡æ¯', 'error');
                return;
            }
            
            try {
                showStatus('ğŸ” æ­£åœ¨æœç´¢ä½ç½®...', 'loading');
                
                // ä½¿ç”¨é«˜å¾·åœ°ç†ç¼–ç API
                const url = `https://restapi.amap.com/v3/geocode/geo?` +
                    `address=${encodeURIComponent(address)}&` +
                    `key=${AMAP_KEY}&` +
                    `output=json`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.status === '1' && data.geocodes && data.geocodes.length > 0) {
                    const geocode = data.geocodes[0];
                    const [lon, lat] = geocode.location.split(',').map(Number);
                    
                    // ä¿å­˜å®šä½æ•°æ®
                    currentLocationData.latitude = lat;
                    currentLocationData.longitude = lon;
                    currentLocationData.accuracy = 100; // åœ°ç†ç¼–ç ç²¾åº¦è®¾ä¸º100ç±³
                    currentLocationData.timestamp = Date.now();
                    currentLocationData.address = geocode.formatted_address;
                    
                    hideStatus();
                    updateAccuracyLevel(2); // ç›´æ¥è¿›å…¥è¡—åŒºçº§
                    showLocationConfirm(currentLocationData.address, currentLocationData.accuracy);
                    
                } else {
                    throw new Error('æœªæ‰¾åˆ°è¯¥ä½ç½®ï¼Œè¯·å°è¯•è¾“å…¥æ›´å…·ä½“çš„åœ°å€');
                }
            } catch (error) {
                showStatus(`âŒ ä½ç½®æœç´¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function getPoiIcon(type) {
            for (const [category, icon] of Object.entries(POI_ICONS)) {
                if (type.includes(category)) return icon;
            }
            return 'ğŸ“';
        }

        function getWalkTime(distance) {
            const minutes = Math.ceil(distance / 80); // å‡è®¾æ­¥è¡Œé€Ÿåº¦80ç±³/åˆ†é’Ÿ
            return minutes <= 1 ? '1åˆ†é’Ÿå†…' : `çº¦${minutes}åˆ†é’Ÿ`;
        }

        function formatDistance(distance) {
            if (distance < 1000) {
                return `${Math.round(distance)}ç±³`;
            } else {
                return `${(distance / 1000).toFixed(1)}å…¬é‡Œ`;
            }
        }

        // çŠ¶æ€ç®¡ç†å’Œç•Œé¢æ§åˆ¶
        function updateAccuracyLevel(level) {
            currentLocationData.accuracyLevel = level;
            
            // æ›´æ–°ç²¾åº¦æŒ‡ç¤ºå™¨
            document.querySelectorAll('.level').forEach(el => {
                el.classList.remove('active', 'target');
                const levelNum = parseInt(el.dataset.level);
                if (levelNum <= level) {
                    el.classList.add('active');
                } else if (levelNum === level + 1) {
                    el.classList.add('target');
                }
            });
            
            // æ›´æ–°è¿›åº¦æ¡
            const progress = ACCURACY_LEVELS[level].progress;
            progressFill.style.width = `${progress}%`;
            progressText.textContent = `å½“å‰ç²¾åº¦: ${ACCURACY_LEVELS[level].name} (${ACCURACY_LEVELS[level].radius}m)`;
            
            if (accuracyProgress.style.display === 'none') {
                accuracyProgress.style.display = 'block';
            }
        }

        function showStatus(message, type = 'loading') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }

        function hideStatus() {
            statusDiv.style.display = 'none';
        }

        function resetInterface() {
            // éšè—æ‰€æœ‰åä½œç•Œé¢
            locationConfirm.style.display = 'none';
            landmarkSelection.style.display = 'none';
            preciseLocation.style.display = 'none';
            collaborationInterface.style.display = 'none';
            coordinatesDiv.style.display = 'none';
            accuracyDiv.style.display = 'none';
            addressInfoDiv.style.display = 'none';
        }

        // æœç´¢å‘¨è¾¹POI (å‡çº§åˆ°POI 2.0 API)
        async function searchNearbyPOIs(longitude, latitude, radius = 1000, keywords = '', accuracyLevel = 1) {
            try {
                // æ ¹æ®ç²¾åº¦ç­‰çº§è°ƒæ•´æœç´¢èŒƒå›´
                let searchRadius = radius;
                if (accuracyLevel <= 2) {
                    // ç²—å®šä½é˜¶æ®µä½¿ç”¨æ›´å¤§çš„æœç´¢åŠå¾„
                    searchRadius = Math.max(radius, 1500); // è‡³å°‘1.5km
                }
                
                // å®šä¹‰å¸¸ç”¨POIç±»å‹ (æ ¹æ®é«˜å¾·æ–‡æ¡£è®¾ç½®ä¸»è¦ç±»å‹)
                const commonTypes = [
                    '050000', // é¤é¥®æœåŠ¡
                    '060000', // è´­ç‰©æœåŠ¡  
                    '070000', // ç”Ÿæ´»æœåŠ¡
                    '080000', // ä½“è‚²ä¼‘é—²æœåŠ¡
                    '090000', // åŒ»ç–—ä¿å¥æœåŠ¡
                    '100000', // ä½å®¿æœåŠ¡
                    '110000', // é£æ™¯åèƒœ
                    '120000', // å•†åŠ¡ä½å®…
                    '130000', // æ”¿åºœæœºæ„åŠç¤¾ä¼šå›¢ä½“
                    '140000', // ç§‘æ•™æ–‡åŒ–æœåŠ¡
                    '150000', // äº¤é€šè®¾æ–½æœåŠ¡
                    '160000', // é‡‘èä¿é™©æœåŠ¡
                    '170000', // å…¬å¸ä¼ä¸š
                    '190000', // å…¬å…±è®¾æ–½
                    '200000'  // äº‹ä»¶æ´»åŠ¨
                ].join('|');
                
                console.log(`ğŸ” æœç´¢å‚æ•°: ç»åº¦=${longitude}, çº¬åº¦=${latitude}, åŠå¾„=${searchRadius}m, ç²¾åº¦ç­‰çº§=${accuracyLevel}`);
                
                // åœ¨çŠ¶æ€ä¸­æ˜¾ç¤ºæœç´¢ä¿¡æ¯
                showStatus(`ğŸ” æœç´¢åŠå¾„${(searchRadius/1000).toFixed(1)}kmå†…çš„åœ°æ ‡...`, 'loading');
                
                // ä½¿ç”¨POIæœç´¢2.0çš„å‘¨è¾¹æœç´¢API
                const url = `https://restapi.amap.com/v5/place/around?` +
                    `location=${longitude},${latitude}&` +
                    `key=${AMAP_KEY}&` +
                    `radius=${searchRadius}&` +
                    `types=${commonTypes}&` +
                    `keywords=${keywords}&` +
                    `show_fields=business,navi,photos,indoor&` +
                    `output=json&` +
                    `page_size=50`; // å¢åŠ é¡µé¢å¤§å°

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }

                const data = await response.json();
                console.log(`APIè¿”å›çŠ¶æ€: ${data.status}, POIæ•°é‡: ${data.pois ? data.pois.length : 0}`);
                
                if (data.status === '1' && data.pois && data.pois.length > 0) {
                    // å‡å°‘è¿‡æ»¤æ¡ä»¶ï¼Œä¿ç•™æ›´å¤šPOI
                    const filteredPois = data.pois
                        .filter(poi => poi.name && poi.name.trim() !== '') // åªè¿‡æ»¤ç©ºåç§°
                        .filter(poi => poi.type_name && !poi.type_name.includes('é“è·¯é™„å±') && !poi.type_name.includes('åœ°ååœ°å€')) // è¿‡æ»¤æ‰ä¸ç›¸å…³çš„ç±»å‹
                        .map(poi => ({
                            id: poi.id,
                            name: poi.name,
                            type: poi.type_name,
                            address: poi.address || '',
                            location: poi.location,
                            distance: parseInt(poi.distance) || 0,
                            business: poi.business || {},
                            photos: poi.photos || [],
                            rating: poi.rating || '0',
                            cost: poi.cost || '',
                            alias: poi.alias || '',
                            tel: poi.tel || ''
                        }))
                        .sort((a, b) => {
                            // æ ¹æ®ç²¾åº¦ç­‰çº§è°ƒæ•´æ’åºç­–ç•¥
                            if (accuracyLevel <= 2) {
                                // ç²—å®šä½é˜¶æ®µï¼šç»¼åˆè¯„åˆ† (çŸ¥ååº¦+è·ç¦»+ç±»å‹)
                                const aScore = (parseFloat(a.rating) || 0) * 0.3 + 
                                              (2000 - a.distance) * 0.0005 + 
                                              getTypeScore(a.type) * 0.4;
                                const bScore = (parseFloat(b.rating) || 0) * 0.3 + 
                                              (2000 - b.distance) * 0.0005 + 
                                              getTypeScore(b.type) * 0.4;
                                return bScore - aScore;
                            } else {
                                // ç²¾ç¡®å®šä½é˜¶æ®µï¼šè·ç¦»ä¼˜å…ˆ
                                return a.distance - b.distance;
                            }
                        })
                        .slice(0, accuracyLevel <= 2 ? 12 : 15); // å¢åŠ æ˜¾ç¤ºæ•°é‡
                    
                    console.log(`è¿‡æ»¤åPOIæ•°é‡: ${filteredPois.length}`);
                    
                    if (filteredPois.length === 0) {
                        console.warn('è¿‡æ»¤åæ²¡æœ‰POIï¼Œå°è¯•é™ä½è¿‡æ»¤æ ‡å‡†...');
                        // å¦‚æœè¿‡æ»¤åæ²¡æœ‰ç»“æœï¼Œè¿”å›è·ç¦»æœ€è¿‘çš„POI
                        const nearestPois = data.pois
                            .filter(poi => poi.name && poi.name.trim() !== '')
                            .sort((a, b) => (parseInt(a.distance) || 0) - (parseInt(b.distance) || 0))
                            .slice(0, 8)
                            .map(poi => ({
                                id: poi.id,
                                name: poi.name,
                                type: poi.type_name || 'æœªçŸ¥ç±»å‹',
                                address: poi.address || '',
                                location: poi.location,
                                distance: parseInt(poi.distance) || 0,
                                business: poi.business || {},
                                photos: poi.photos || [],
                                rating: poi.rating || '0',
                                cost: poi.cost || '',
                                alias: poi.alias || '',
                                tel: poi.tel || ''
                            }));
                        console.log(`é™çº§å¤„ç†ï¼Œè¿”å›æœ€è¿‘çš„${nearestPois.length}ä¸ªPOI`);
                        return nearestPois;
                    }
                    
                    return filteredPois;
                } else {
                    console.warn(`APIè°ƒç”¨å¤±è´¥æˆ–æ— æ•°æ®: status=${data.status}, info=${data.info}`);
                    throw new Error(data.info || 'POIæœç´¢å¤±è´¥');
                }
            } catch (error) {
                console.error('æœç´¢POIå¤±è´¥:', error);
                console.error('API URL:', error.url || 'æœªçŸ¥');
                return [];
            }
        }

        function getTypeScore(type) {
            // æ ¹æ®POIç±»å‹ç»™å‡ºé‡è¦æ€§è¯„åˆ† (æ‰©å¤§ç±»å‹èŒƒå›´)
            const veryHighPriorityTypes = ['è´­ç‰©æœåŠ¡', 'é¤é¥®æœåŠ¡', 'ä½å®¿æœåŠ¡'];
            const highPriorityTypes = ['åŒ»ç–—ä¿å¥', 'äº¤é€šè®¾æ–½', 'æ•™è‚²æ–‡åŒ–', 'é‡‘èä¿é™©', 'ä½“è‚²ä¼‘é—²'];
            const mediumPriorityTypes = ['ç”Ÿæ´»æœåŠ¡', 'å•†åŠ¡ä½å®…', 'æ”¿åºœæœºæ„', 'é£æ™¯åèƒœ', 'å…¬å¸ä¼ä¸š'];
            const lowPriorityTypes = ['å…¬å…±è®¾æ–½', 'äº‹ä»¶æ´»åŠ¨'];
            
            if (veryHighPriorityTypes.some(t => type.includes(t))) return 1.0;
            if (highPriorityTypes.some(t => type.includes(t))) return 0.8;
            if (mediumPriorityTypes.some(t => type.includes(t))) return 0.6;
            if (lowPriorityTypes.some(t => type.includes(t))) return 0.4;
            return 0.3; // å…¶ä»–ç±»å‹ä¹Ÿç»™ä¸€å®šåˆ†æ•°
        }

        // ä½ç½®ç¡®è®¤ç•Œé¢
        function showLocationConfirm(address, accuracy) {
            locationConfirm.innerHTML = `
                <h2>ğŸ“ æˆ‘ä»¬æ£€æµ‹åˆ°æ‚¨å¯èƒ½åœ¨ï¼š</h2>
                <div class="address-big">${address}</div>
                <div class="accuracy-note">å®šä½ç²¾åº¦èŒƒå›´: çº¦${Math.round(accuracy)}ç±³</div>
                
                <div class="distance-helper">
                    <h3>ğŸ¤” å¦‚ä½•åˆ¤æ–­ä½ç½®å‡†ç¡®æ€§ï¼š</h3>
                    <ul>
                        <li>ğŸ‘€ <strong>50ç±³å†…</strong> - èƒ½æ¸…æ¥šçœ‹åˆ°å‘¨å›´å»ºç­‘</li>
                        <li>ğŸš¶â€â™‚ï¸ <strong>100ç±³å†…</strong> - æ­¥è¡Œ1-2åˆ†é’Ÿèƒ½åˆ°è¾¾</li>
                        <li>ğŸƒâ€â™‚ï¸ <strong>200ç±³å†…</strong> - è·‘æ­¥1åˆ†é’Ÿèƒ½åˆ°è¾¾</li>
                    </ul>
                </div>
                
                <div class="confirm-buttons">
                    <button class="btn-yes" onclick="handleLocationConfirm('yes')">âœ… æ˜¯çš„ï¼Œæˆ‘åœ¨è¿™é™„è¿‘</button>
                    <button class="btn-unknown" onclick="handleLocationConfirm('unknown')">ğŸ¤·â€â™‚ï¸ ä¸ç¡®å®š</button>
                    <button class="btn-no" onclick="handleLocationConfirm('no')">âŒ ä¸å¯¹ï¼Œé‡æ–°å®šä½</button>
                </div>
            `;
            
            locationConfirm.style.display = 'block';
            collaborationInterface.style.display = 'block';
        }

        // åœ°æ ‡é€‰æ‹©ç•Œé¢
        function showLandmarkSelection(pois) {
            const poiCards = pois.map(poi => {
                // æ„å»ºè¯„åˆ†å’Œä»·æ ¼ä¿¡æ¯
                let extraInfo = '';
                if (poi.rating && parseFloat(poi.rating) > 0) {
                    const stars = 'â­'.repeat(Math.round(parseFloat(poi.rating)));
                    extraInfo += `<div style="font-size: 12px; color: #fa8c16;">è¯„åˆ†: ${stars} (${poi.rating})</div>`;
                }
                if (poi.cost && poi.cost !== '0') {
                    extraInfo += `<div style="font-size: 12px; color: #52c41a;">ğŸ’° äººå‡: ${poi.cost}å…ƒ</div>`;
                }
                if (poi.tel) {
                    extraInfo += `<div style="font-size: 11px; color: #666;">ğŸ“ ${poi.tel}</div>`;
                }
                
                return `
                    <div class="landmark-card" onclick="selectLandmark('${poi.id}')">
                        <div class="landmark-icon">${getPoiIcon(poi.type)}</div>
                        <h4>${poi.name}${poi.alias ? ` (${poi.alias})` : ''}</h4>
                        <div class="distance">ğŸ“ è·ç¦»çº¦ ${formatDistance(poi.distance)}</div>
                        <div class="time">ğŸš¶â€â™‚ï¸ ${getWalkTime(poi.distance)}</div>
                        ${extraInfo}
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">${poi.type}</div>
                        <button class="select-landmark">é€‰æ‹©è¿™é‡Œ</button>
                    </div>
                `;
            }).join('');

            landmarkSelection.innerHTML = `
                <h3>ğŸ¢ è¯·é€‰æ‹©æ‚¨ç†Ÿæ‚‰æˆ–èƒ½çœ‹åˆ°çš„åœ°æ ‡ï¼š</h3>
                <div class="distance-helper">
                    <p><strong>ğŸ’¡ é€‰æ‹©æŠ€å·§ï¼š</strong>é€‰æ‹©æ‚¨æœ€ç†Ÿæ‚‰ã€æœ€å®¹æ˜“è¯†åˆ«çš„åœ°æ ‡ï¼Œè¿™å°†å¸®åŠ©æˆ‘ä»¬è¿›ä¸€æ­¥ç²¾ç¡®å®šä½ã€‚</p>
                </div>
                
                <div class="landmarks-grid">
                    ${poiCards}
                </div>
                
                <div class="no-landmark">
                    <button class="btn-none" onclick="expandSearchRange()">ğŸ” éƒ½ä¸è®¤è¯†ï¼Œæœç´¢æ›´è¿œèŒƒå›´</button>
                    <button class="btn-none" onclick="restartLocation()" style="margin-left: 10px; background: #ff4d4f;">ğŸ”„ é‡æ–°å®šä½</button>
                </div>
            `;
            
            landmarkSelection.style.display = 'block';
            collaborationInterface.style.display = 'block';
        }

        // ç²¾ç¡®ä½ç½®ç¡®å®šç•Œé¢
        function showPreciseLocation(centerPoi, nearbyPois) {
            const directions = ['åŒ—', 'ä¸œ', 'å—', 'è¥¿'];
            const directionCards = directions.map(direction => {
                const directionalPois = nearbyPois
                    .filter(poi => poi.id !== centerPoi.id)
                    .slice(0, 2)
                    .map(poi => `<div style="font-size: 12px; margin: 2px 0;">â€¢ ${poi.name}</div>`)
                    .join('');
                
                return `
                    <div class="direction-option" onclick="selectDirection('${direction}')">
                        <div class="direction-label">${centerPoi.name} ${direction}ä¾§</div>
                        <div class="nearby-pois">${directionalPois || '<div style="font-size: 12px; color: #999;">æš‚æ— å‚è€ƒ</div>'}</div>
                    </div>
                `;
            }).join('');

            preciseLocation.innerHTML = `
                <h3>ğŸ¯ ä»¥"${centerPoi.name}"ä¸ºä¸­å¿ƒï¼Œæ‚¨å…·ä½“åœ¨å“ªä¸ªæ–¹å‘ï¼Ÿ</h3>
                
                <div class="direction-grid">
                    ${directionCards}
                </div>
                
                <div class="distance-selector">
                    <h4>ğŸ“ æ‚¨è·ç¦»"${centerPoi.name}"å¤§çº¦å¤šè¿œï¼Ÿ</h4>
                    <div class="distance-buttons">
                        <button onclick="selectDistance(10)">ğŸ”¥ å¾ˆè¿‘ (10ç±³å†…)</button>
                        <button onclick="selectDistance(30)">ğŸ‘€ èƒ½çœ‹æ¸… (30ç±³å†…)</button>
                        <button onclick="selectDistance(80)">ğŸš¶â€â™‚ï¸ èµ°å‡ æ­¥ (80ç±³å†…)</button>
                        <button onclick="selectDistance(150)">ğŸƒâ€â™‚ï¸ è·‘ä¸€ä¸‹ (150ç±³å†…)</button>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn-yes" onclick="finalizePreciseLocation()">âœ… ç¡®è®¤æœ€ç»ˆä½ç½®</button>
                    <button class="btn-unknown" onclick="selectDifferentLandmark()" style="margin-left: 10px;">ğŸ”„ é€‰æ‹©å…¶ä»–åœ°æ ‡</button>
                </div>
            `;
            
            preciseLocation.style.display = 'block';
            collaborationInterface.style.display = 'block';
        }

        // äº‹ä»¶å¤„ç†å‡½æ•°
        let selectedDirection = null;
        let selectedDistance = null;
        let currentPois = [];

        async function handleLocationConfirm(action) {
            locationConfirm.style.display = 'none';
            
            if (action === 'yes' || action === 'unknown') {
                // è¿›å…¥åœ°æ ‡é€‰æ‹©é˜¶æ®µ
                showStatus('ğŸ” æ­£åœ¨æœç´¢å‘¨è¾¹åœ°æ ‡...', 'loading');
                updateAccuracyLevel(2);
                
                try {
                    // ä½¿ç”¨æ›´å¤§çš„æœç´¢åŠå¾„ç¡®ä¿èƒ½æ‰¾åˆ°POI
                    const radius = Math.max(ACCURACY_LEVELS[2].radius, 2000); // è‡³å°‘2km
                    const pois = await searchNearbyPOIs(
                        currentLocationData.longitude, 
                        currentLocationData.latitude, 
                        radius,
                        '', // keywords
                        2   // accuracyLevel - è¡—åŒºçº§
                    );
                    
                    currentPois = pois;
                    hideStatus();
                    
                    if (pois.length > 0) {
                        showLandmarkSelection(pois);
                    } else {
                        showStatus('ğŸ˜… é™„è¿‘æ²¡æœ‰æ‰¾åˆ°çŸ¥ååœ°æ ‡ï¼Œæ­£åœ¨è‡ªåŠ¨æ‰©å¤§æœç´¢èŒƒå›´...', 'loading');
                        setTimeout(() => expandSearchRange(), 1000);
                    }
                } catch (error) {
                    showStatus('âŒ æœç´¢åœ°æ ‡å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } else {
                // é‡æ–°å®šä½
                restartLocation();
            }
        }

        async function selectLandmark(poiId) {
            // æ‰¾åˆ°é€‰ä¸­çš„POI
            const selectedPoi = currentPois.find(poi => poi.id === poiId);
            if (!selectedPoi) return;
            
            currentLocationData.selectedPoi = selectedPoi;
            landmarkSelection.style.display = 'none';
            
            // è¿›å…¥ç²¾ç¡®ä½ç½®ç¡®å®šé˜¶æ®µ
            showStatus('ğŸ¯ æ­£åœ¨åŠ è½½ç²¾ç¡®å®šä½é€‰é¡¹...', 'loading');
            updateAccuracyLevel(3);
            
            try {
                // è·å–é€‰ä¸­POIå‘¨è¾¹çš„æ›´è¯¦ç»†ä¿¡æ¯
                const [lon, lat] = selectedPoi.location.split(',').map(Number);
                const nearbyPois = await searchNearbyPOIs(lon, lat, 100, '', 3); // å•†åœˆçº§ç²¾åº¦
                
                hideStatus();
                showPreciseLocation(selectedPoi, nearbyPois);
            } catch (error) {
                hideStatus();
                showPreciseLocation(selectedPoi, []);
            }
        }

        function selectDirection(direction) {
            selectedDirection = direction;
            
            // æ›´æ–°UIçŠ¶æ€
            document.querySelectorAll('.direction-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.target.closest('.direction-option').classList.add('selected');
        }

        function selectDistance(distance) {
            selectedDistance = distance;
            
            // æ›´æ–°UIçŠ¶æ€
            document.querySelectorAll('.distance-buttons button').forEach(el => {
                el.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        async function finalizePreciseLocation() {
            if (!selectedDirection || !selectedDistance) {
                showStatus('âš ï¸ è¯·é€‰æ‹©æ–¹å‘å’Œè·ç¦»', 'error');
                return;
            }
            
            updateAccuracyLevel(4);
            preciseLocation.style.display = 'none';
            
            // è®¡ç®—æœ€ç»ˆä½ç½®ï¼ˆç®€åŒ–è®¡ç®—ï¼‰
            const poi = currentLocationData.selectedPoi;
            const [poiLon, poiLat] = poi.location.split(',').map(Number);
            
            // æ ¹æ®æ–¹å‘å’Œè·ç¦»è°ƒæ•´åæ ‡ï¼ˆç®€åŒ–å¤„ç†ï¼‰
            let finalLat = poiLat;
            let finalLon = poiLon;
            
            const distanceKm = selectedDistance / 1000;
            const latOffset = distanceKm / 111; // 1åº¦çº¬åº¦çº¦111km
            const lonOffset = distanceKm / (111 * Math.cos(poiLat * Math.PI / 180));
            
            switch(selectedDirection) {
                case 'åŒ—': finalLat += latOffset; break;
                case 'å—': finalLat -= latOffset; break;
                case 'ä¸œ': finalLon += lonOffset; break;
                case 'è¥¿': finalLon -= lonOffset; break;
            }
            
            currentLocationData.finalLocation = {
                latitude: finalLat,
                longitude: finalLon,
                accuracy: selectedDistance,
                method: 'human_assisted',
                basedOn: poi.name,
                direction: selectedDirection,
                distance: selectedDistance
            };
            
            // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            await showFinalResults();
        }

        async function showFinalResults() {
            showStatus('âœ… å®šä½å®Œæˆï¼æ­£åœ¨ç”Ÿæˆè¯¦ç»†åœ°å€...', 'success');
            
            const final = currentLocationData.finalLocation;
            
            // æ˜¾ç¤ºæœ€ç»ˆåæ ‡ä¿¡æ¯
            coordinatesDiv.innerHTML = `
                <h3>ğŸ¯ æ™ºèƒ½åä½œå®šä½ç»“æœ</h3>
                <div><strong>æœ€ç»ˆçº¬åº¦:</strong> ${final.latitude.toFixed(8)}</div>
                <div><strong>æœ€ç»ˆç»åº¦:</strong> ${final.longitude.toFixed(8)}</div>
                <div><strong>å®šä½æ–¹æ³•:</strong> äººæœºåä½œæ™ºèƒ½å®šä½</div>
                <div><strong>å‚è€ƒåœ°æ ‡:</strong> ${final.basedOn}</div>
                <div><strong>ç›¸å¯¹ä½ç½®:</strong> ${final.basedOn}${final.direction}ä¾§çº¦${final.distance}ç±³</div>
                <div class="confidence-meter">
                    <span>å®šä½ç½®ä¿¡åº¦ï¼š</span>
                    <div class="confidence-stars">â­â­â­â­â­ (95% å‡†ç¡®)</div>
                </div>
            `;
            coordinatesDiv.style.display = 'block';
            
            // æ˜¾ç¤ºç²¾åº¦ä¿¡æ¯
            accuracyDiv.innerHTML = `
                <h3>ğŸ† å®šä½ç²¾åº¦ä¿¡æ¯</h3>
                <div><strong>é¢„ä¼°ç²¾åº¦:</strong> ${final.accuracy}ç±³ åŠå¾„</div>
                <div><strong>ç²¾åº¦ç­‰çº§:</strong> ğŸ¯ ç²¾ç¡®çº§åˆ« (äººæœºåä½œ)</div>
                <div><strong>æå‡æ•ˆæœ:</strong> ä»${Math.round(currentLocationData.accuracy)}ç±³ â†’ ${final.accuracy}ç±³</div>
                <div><strong>è¯´æ˜:</strong> é€šè¿‡äººæœºåä½œæ–¹å¼å¤§å¹…æå‡äº†å®šä½ç²¾åº¦</div>
            `;
            accuracyDiv.style.display = 'block';
            
            // è·å–æœ€ç»ˆä½ç½®çš„åœ°å€ä¿¡æ¯
            try {
                await reverseGeocode(final.longitude, final.latitude, true);
                hideStatus();
                
                // é‡ç½®æŒ‰é’®
                locationBtn.disabled = false;
                locationBtn.textContent = 'ğŸš€ é‡æ–°å¼€å§‹å®šä½';
            } catch (error) {
                hideStatus();
                showStatus('â„¹ï¸ å®šä½å·²å®Œæˆï¼Œåœ°å€è§£æå¤±è´¥', 'error');
                
                // å³ä½¿åœ°å€è§£æå¤±è´¥ï¼Œä¹Ÿè¦é‡ç½®æŒ‰é’®
                locationBtn.disabled = false;
                locationBtn.textContent = 'ğŸš€ é‡æ–°å¼€å§‹å®šä½';
            }
        }

        async function expandSearchRange() {
            landmarkSelection.style.display = 'none';
            showStatus('ğŸ” æ‰©å¤§æœç´¢èŒƒå›´ï¼Œå¯»æ‰¾æ›´å¤šåœ°æ ‡...', 'loading');
            
            try {
                // å¤§å¹…æ‰©å¤§æœç´¢èŒƒå›´
                const expandedRadius = Math.max(ACCURACY_LEVELS[1].radius * 3, 5000); // è‡³å°‘5km
                const pois = await searchNearbyPOIs(
                    currentLocationData.longitude, 
                    currentLocationData.latitude, 
                    expandedRadius,
                    '', // keywords
                    1   // accuracyLevel - åŒºåŸŸçº§ï¼ˆæ‰©å¤§æœç´¢ï¼‰
                );
                
                currentPois = pois;
                hideStatus();
                
                if (pois.length > 0) {
                    showLandmarkSelection(pois);
                } else {
                    showStatus('ğŸ˜… æ‰©å¤§èŒƒå›´åä»æœªæ‰¾åˆ°åœ°æ ‡ï¼Œä¸ºæ‚¨æä¾›å…¶ä»–é€‰é¡¹...', 'error');
                    
                    // æ˜¾ç¤ºæ›¿ä»£é€‰é¡¹
                    setTimeout(() => {
                        const fallbackHtml = `
                            <div class="location-confirm">
                                <h2>ğŸ¤” æœªæ‰¾åˆ°é™„è¿‘åœ°æ ‡</h2>
                                <div class="accuracy-note">
                                    åœ¨å½“å‰ä½ç½®${Math.round(expandedRadius/1000)}kmèŒƒå›´å†…æœªæ‰¾åˆ°åˆé€‚çš„åœ°æ ‡ã€‚
                                </div>
                                
                                <div class="confirm-buttons" style="flex-direction: column; gap: 15px;">
                                    <button class="btn-yes" onclick="showManualLocationInput()" style="background: #fa8c16;">
                                        âœï¸ æ‰‹åŠ¨è¾“å…¥è¯¦ç»†ä½ç½®
                                    </button>
                                    <button class="btn-unknown" onclick="tryIPLocation()" style="background: #52c41a;">
                                        ğŸŒ å°è¯•IPå®šä½
                                    </button>
                                    <button class="btn-no" onclick="restartLocation()" style="background: #6c757d;">
                                        ğŸ”„ é‡æ–°GPSå®šä½
                                    </button>
                                </div>
                                
                                <div style="margin-top: 15px; font-size: 12px; color: #666;">
                                    ğŸ’¡ å»ºè®®æ‰‹åŠ¨è¾“å…¥ï¼Œè¿™æ ·å¯ä»¥è·å¾—æœ€å‡†ç¡®çš„ä½ç½®ä¿¡æ¯
                                </div>
                            </div>
                        `;
                        
                        hideStatus();
                        locationConfirm.innerHTML = fallbackHtml;
                        locationConfirm.style.display = 'block';
                        collaborationInterface.style.display = 'block';
                    }, 2000);
                }
            } catch (error) {
                showStatus('âŒ æ‰©å¤§æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        function selectDifferentLandmark() {
            preciseLocation.style.display = 'none';
            updateAccuracyLevel(2);
            showLandmarkSelection(currentPois);
        }

        function restartLocation() {
            resetInterface();
            updateAccuracyLevel(1);
            selectedDirection = null;
            selectedDistance = null;
            currentPois = [];
            currentLocationData = {
                latitude: null,
                longitude: null,
                accuracy: null,
                timestamp: null,
                address: null,
                accuracyLevel: 1,
                selectedPoi: null,
                finalLocation: null
            };
            
            locationBtn.disabled = false;
            locationBtn.textContent = 'ğŸš€ å¼€å§‹æ™ºèƒ½å®šä½';
            hideStatus();
        }

        // è¯„ä¼°å®šä½ç²¾åº¦
        function getAccuracyRating(accuracy) {
            if (accuracy <= 10) return 'ğŸŸ¢ æé«˜ç²¾åº¦ (GPSçº§åˆ«)';
            if (accuracy <= 50) return 'ğŸ”µ é«˜ç²¾åº¦ (åŸå¸‚å¯¼èˆªçº§åˆ«)';
            if (accuracy <= 200) return 'ğŸŸ¡ ä¸­ç­‰ç²¾åº¦ (åŒºåŸŸå®šä½çº§åˆ«)';
            if (accuracy <= 1000) return 'ğŸŸ  ä½ç²¾åº¦ (å¤§è‡´åŒºåŸŸ)';
            return 'ğŸ”´ å¾ˆä½ç²¾åº¦ (ä»…ä¾›å‚è€ƒ)';
        }

        // è°ƒç”¨é«˜å¾·é€†åœ°ç†ç¼–ç API
        async function reverseGeocode(lon, lat, showResult = false) {
            try {
                const url = `https://restapi.amap.com/v3/geocode/regeo?` +
                    `location=${lon},${lat}&` +
                    `key=${AMAP_KEY}&` +
                    `radius=1000&` +
                    `extensions=all&` +
                    `output=json`;

                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === '1' && data.regeocode) {
                    if (showResult) {
                        showAddressInfo(data.regeocode);
                    }
                    return data.regeocode;
                } else {
                    throw new Error(data.info || 'åœ°å€è§£æå¤±è´¥');
                }
            } catch (error) {
                console.error('é€†åœ°ç†ç¼–ç å¤±è´¥:', error);
                throw error;
            }
        }

        // æ˜¾ç¤ºåœ°å€ä¿¡æ¯ï¼ˆæœ€ç»ˆç»“æœï¼‰
        function showAddressInfo(regeocode) {
            const addressComponent = regeocode.addressComponent;
            const pois = regeocode.pois || [];
            const final = currentLocationData.finalLocation;
            
            let html = `
                <h3>ğŸ  æœ€ç»ˆä½ç½®è¯¦ç»†åœ°å€</h3>
                
                <div class="address-item">
                    <span class="label">å®Œæ•´åœ°å€:</span>
                    ${regeocode.formatted_address || 'æ— '}
                </div>
                
                <div class="address-item">
                    <span class="label">çœä»½:</span>
                    ${addressComponent.province || 'æ— '}
                </div>
                
                <div class="address-item">
                    <span class="label">åŸå¸‚:</span>
                    ${addressComponent.city || addressComponent.province || 'æ— '}
                </div>
                
                <div class="address-item">
                    <span class="label">åŒºå¿:</span>
                    ${addressComponent.district || 'æ— '}
                </div>
                
                <div class="address-item">
                    <span class="label">ä¹¡é•‡/è¡—é“:</span>
                    ${addressComponent.township || 'æ— '}
                </div>
            `;

            if (final) {
                html += `
                    <div class="address-item">
                        <span class="label">å®šä½æè¿°:</span>
                        ä½äº${final.basedOn}${final.direction}ä¾§çº¦${final.distance}ç±³å¤„
                    </div>
                `;
            }

            // æ˜¾ç¤ºé™„è¿‘é‡è¦POI
            if (pois.length > 0) {
                html += `<h4>ğŸ“ å‘¨è¾¹å‚è€ƒåœ°æ ‡:</h4>`;
                pois.slice(0, 3).forEach((poi, index) => {
                    html += `
                        <div class="address-item">
                            <span class="label">${getPoiIcon(poi.type)}</span>
                            ${poi.name} - è·ç¦»${poi.distance}ç±³
                        </div>
                    `;
                });
            }

            addressInfoDiv.innerHTML = html;
            addressInfoDiv.style.display = 'block';
        }

        // è·å–å•æ¬¡ä½ç½®çš„PromiseåŒ…è£…
        function getSinglePosition() {
            return new Promise((resolve, reject) => {
                const options = {
                    enableHighAccuracy: true,    // å¯ç”¨é«˜ç²¾åº¦æ¨¡å¼
                    timeout: 8000,               // 8ç§’è¶…æ—¶ï¼ˆå•æ¬¡ï¼‰
                    maximumAge: 0                // å¼ºåˆ¶ä¸ä½¿ç”¨ç¼“å­˜ä½ç½®
                };

                navigator.geolocation.getCurrentPosition(resolve, reject, options);
            });
        }

        // å»¶è¿Ÿå‡½æ•°
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // è¿ç»­è·å–3æ¬¡ä½ç½®å¹¶è®¡ç®—å¹³å‡å€¼
        async function getAverageLocation() {
            const positions = [];
            const totalAttempts = 3;
            
            for (let i = 0; i < totalAttempts; i++) {
                try {
                    showStatus(`ğŸ›°ï¸ æ­£åœ¨è¿›è¡Œç¬¬ ${i + 1}/${totalAttempts} æ¬¡å®šä½...`, 'loading');
                    
                    const position = await getSinglePosition();
                    positions.push({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: position.timestamp
                    });
                    
                    console.log(`ç¬¬${i + 1}æ¬¡å®šä½ç»“æœ:`, {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    });
                    
                    // é™¤äº†æœ€åä¸€æ¬¡ï¼Œéƒ½éœ€è¦ç­‰å¾…0.5ç§’
                    if (i < totalAttempts - 1) {
                        await delay(500);
                    }
                    
                } catch (error) {
                    console.warn(`ç¬¬${i + 1}æ¬¡å®šä½å¤±è´¥:`, error);
                    // å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡
                    if (i < totalAttempts - 1) {
                        await delay(500);
                        continue;
                    } else {
                        throw error; // æœ€åä¸€æ¬¡å¤±è´¥åˆ™æŠ›å‡ºé”™è¯¯
                    }
                }
            }

            if (positions.length === 0) {
                throw new Error('æ‰€æœ‰å®šä½å°è¯•å‡å¤±è´¥');
            }

            // è®¡ç®—å¹³å‡å€¼
            const avgLat = positions.reduce((sum, pos) => sum + pos.latitude, 0) / positions.length;
            const avgLon = positions.reduce((sum, pos) => sum + pos.longitude, 0) / positions.length;
            const avgAccuracy = positions.reduce((sum, pos) => sum + pos.accuracy, 0) / positions.length;
            const latestTimestamp = Math.max(...positions.map(pos => pos.timestamp));

            // è®¡ç®—ä½ç½®å˜åŒ–èŒƒå›´ï¼ˆæœ€å¤§æœ€å°å€¼å·®å¼‚ï¼‰
            const latRange = Math.max(...positions.map(p => p.latitude)) - Math.min(...positions.map(p => p.latitude));
            const lonRange = Math.max(...positions.map(p => p.longitude)) - Math.min(...positions.map(p => p.longitude));
            const accuracyRange = Math.max(...positions.map(p => p.accuracy)) - Math.min(...positions.map(p => p.accuracy));

            return {
                latitude: avgLat,
                longitude: avgLon,
                accuracy: avgAccuracy,
                timestamp: latestTimestamp,
                positionCount: positions.length,
                positionVariance: {
                    latRange: latRange,
                    lonRange: lonRange,
                    accuracyRange: accuracyRange
                },
                rawPositions: positions
            };
        }

        // æ™ºèƒ½åä½œå®šä½ä¸»æµç¨‹ (æ”¯æŒå¤šå¹³å°)
        async function getCurrentLocation() {
            // é‡ç½®ç•Œé¢å’ŒçŠ¶æ€
            resetInterface();
            updateAccuracyLevel(1);
            
            locationBtn.disabled = true;
            
            // æ£€æµ‹è®¾å¤‡ç±»å‹
            const device = detectDevice();
            console.log('è®¾å¤‡æ£€æµ‹ç»“æœ:', device);
            
            if (!device.hasGPS) {
                showLocationSelectionInterface(device);
                return;
            }

            // æ ¹æ®è®¾å¤‡ç±»å‹è°ƒæ•´ç­–ç•¥
            if (device.isDesktop) {
                showDesktopLocationOptions();
            } else {
                // ç§»åŠ¨ç«¯ç›´æ¥å°è¯•GPSå®šä½
                attemptGPSLocation();
            }
        }

        // æ˜¾ç¤ºæ¡Œé¢ç«¯å®šä½é€‰é¡¹
        function showDesktopLocationOptions() {
            locationBtn.textContent = 'ğŸ’» ç”µè„‘ç«¯å®šä½';
            
            const optionsHtml = `
                <div class="location-confirm">
                    <h2>ğŸ’» ç”µè„‘ç«¯å®šä½é€‰é¡¹</h2>
                    <div class="accuracy-note">ç”µè„‘ç«¯å®šä½ç²¾åº¦ç›¸å¯¹è¾ƒä½ï¼Œè¯·é€‰æ‹©åˆé€‚çš„å®šä½æ–¹å¼ï¼š</div>
                    
                    <div class="confirm-buttons" style="flex-direction: column; gap: 15px;">
                        <button class="btn-yes" onclick="attemptGPSLocation()" style="background: #1890ff;">
                            ğŸ›°ï¸ å°è¯•GPSå®šä½ (æ¨è)
                        </button>
                        <button class="btn-unknown" onclick="tryIPLocation()" style="background: #52c41a;">
                            ğŸŒ IPå®šä½ (ç²¾åº¦çº¦5km)
                        </button>
                        <button class="btn-no" onclick="showManualLocationInput()" style="background: #fa8c16;">
                            âœï¸ æ‰‹åŠ¨è¾“å…¥ä½ç½® (æœ€å‡†ç¡®)
                        </button>
                    </div>
                    
                    <div style="margin-top: 15px; font-size: 12px; color: #666; text-align: left;">
                        <div><strong>ğŸ’¡ å»ºè®®ï¼š</strong></div>
                        <div>â€¢ ğŸ“± <strong>GPSå®šä½</strong>ï¼šéœ€è¦æµè§ˆå™¨æƒé™ï¼Œç²¾åº¦æœ€é«˜</div>
                        <div>â€¢ ğŸŒ <strong>IPå®šä½</strong>ï¼šæ— éœ€æƒé™ï¼Œå¿«é€Ÿä½†ç²¾åº¦è¾ƒä½</div>
                        <div>â€¢ âœï¸ <strong>æ‰‹åŠ¨è¾“å…¥</strong>ï¼šè‡ªå·±è¾“å…¥å½“å‰ä½ç½®ï¼Œç²¾åº¦æœ€å¯æ§</div>
                    </div>
                </div>
            `;
            
            locationConfirm.innerHTML = optionsHtml;
            locationConfirm.style.display = 'block';
            collaborationInterface.style.display = 'block';
        }

        // æ˜¾ç¤ºä¸æ”¯æŒå®šä½çš„é€‰æ‹©ç•Œé¢
        function showLocationSelectionInterface(device) {
            locationBtn.textContent = 'âŒ ä¸æ”¯æŒå®šä½';
            
            const fallbackHtml = `
                <div class="location-confirm">
                    <h2>âš ï¸ å®šä½åŠŸèƒ½ä¸å¯ç”¨</h2>
                    <div class="accuracy-note">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½åŠŸèƒ½ï¼Œä½†æ‚¨ä»å¯ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š
                    </div>
                    
                    <div class="confirm-buttons" style="flex-direction: column; gap: 15px;">
                        <button class="btn-yes" onclick="tryIPLocation()" style="background: #52c41a;">
                            ğŸŒ ä½¿ç”¨IPå®šä½
                        </button>
                        <button class="btn-unknown" onclick="showManualLocationInput()" style="background: #fa8c16;">
                            âœï¸ æ‰‹åŠ¨è¾“å…¥ä½ç½®
                        </button>
                    </div>
                </div>
            `;
            
            locationConfirm.innerHTML = fallbackHtml;
            locationConfirm.style.display = 'block';
            collaborationInterface.style.display = 'block';
        }

        // å°è¯•GPSå®šä½
        async function attemptGPSLocation() {
            locationBtn.textContent = 'ğŸ›°ï¸ GPSå®šä½ä¸­...';
            showStatus('ğŸ›°ï¸ æ­£åœ¨è¿›è¡Œå¤šæ¬¡å®šä½é‡‡æ ·ï¼Œè¯·ç¨å€™...', 'loading');
            locationConfirm.style.display = 'none';

            try {
                // ç¬¬ä¸€é˜¶æ®µï¼šå¤šæ¬¡GPSå®šä½å–å¹³å‡å€¼
                const averageResult = await getAverageLocation();
                
                // ä¿å­˜åŸºç¡€å®šä½æ•°æ®
                currentLocationData.latitude = averageResult.latitude;
                currentLocationData.longitude = averageResult.longitude;
                currentLocationData.accuracy = averageResult.accuracy;
                currentLocationData.timestamp = averageResult.timestamp;
                
                // ç¬¬äºŒé˜¶æ®µï¼šé€†åœ°ç†ç¼–ç è·å–åœ°å€
                showStatus('ğŸ” æ­£åœ¨è§£æåœ°å€ä¿¡æ¯...', 'loading');
                const addressData = await reverseGeocode(averageResult.longitude, averageResult.latitude);
                currentLocationData.address = addressData.formatted_address;
                
                hideStatus();
                
                // ç¬¬ä¸‰é˜¶æ®µï¼šå¯åŠ¨äººæœºåä½œç¡®è®¤æµç¨‹
                showLocationConfirm(currentLocationData.address, currentLocationData.accuracy);
                
            } catch (error) {
                console.error('GPSå®šä½å¤±è´¥:', error);
                
                // GPSå®šä½å¤±è´¥ï¼Œæä¾›é™çº§é€‰é¡¹
                showGPSFailureOptions(error);
            }
        }

        // GPSå®šä½å¤±è´¥åçš„é€‰é¡¹
        function showGPSFailureOptions(error) {
            let errorMessage = '';
            switch(error.code) {
                case 1: // PERMISSION_DENIED
                    errorMessage = 'ç”¨æˆ·æ‹’ç»äº†å®šä½æƒé™';
                    break;
                case 2: // POSITION_UNAVAILABLE
                    errorMessage = 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨';
                    break;
                case 3: // TIMEOUT
                    errorMessage = 'å®šä½è¯·æ±‚è¶…æ—¶';
                    break;
                default:
                    errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';
                    break;
            }
            
            const fallbackHtml = `
                <div class="location-confirm">
                    <h2>âš ï¸ GPSå®šä½å¤±è´¥</h2>
                    <div class="accuracy-note" style="color: #ff4d4f;">
                        é”™è¯¯åŸå› ï¼š${errorMessage}
                    </div>
                    <div style="margin: 15px 0; font-size: 14px; color: #666;">
                        æ²¡å…³ç³»ï¼Œæˆ‘ä»¬ä¸ºæ‚¨æä¾›å…¶ä»–å®šä½æ–¹å¼ï¼š
                    </div>
                    
                    <div class="confirm-buttons" style="flex-direction: column; gap: 15px;">
                        <button class="btn-yes" onclick="tryIPLocation()" style="background: #52c41a;">
                            ğŸŒ ä½¿ç”¨IPå®šä½ (è‡ªåŠ¨)
                        </button>
                        <button class="btn-unknown" onclick="showManualLocationInput()" style="background: #fa8c16;">
                            âœï¸ æ‰‹åŠ¨è¾“å…¥ä½ç½® (æ¨è)
                        </button>
                        <button class="btn-no" onclick="restartLocation()" style="background: #6c757d;">
                            ğŸ”„ é‡æ–°å°è¯•GPS
                        </button>
                    </div>
                </div>
            `;
            
            hideStatus();
            locationConfirm.innerHTML = fallbackHtml;
            locationConfirm.style.display = 'block';
            collaborationInterface.style.display = 'block';
            
            locationBtn.disabled = false;
            locationBtn.textContent = 'ğŸš€ å¼€å§‹æ™ºèƒ½å®šä½';
        }

        // å°è¯•IPå®šä½
        async function tryIPLocation() {
            locationConfirm.style.display = 'none';
            
            try {
                const ipResult = await getLocationByIP();
                
                // ä¿å­˜IPå®šä½æ•°æ®
                currentLocationData.latitude = ipResult.latitude;
                currentLocationData.longitude = ipResult.longitude;
                currentLocationData.accuracy = ipResult.accuracy;
                currentLocationData.timestamp = ipResult.timestamp;
                
                // è·å–åœ°å€ä¿¡æ¯
                showStatus('ğŸ” æ­£åœ¨è§£æåœ°å€ä¿¡æ¯...', 'loading');
                const addressData = await reverseGeocode(ipResult.longitude, ipResult.latitude);
                currentLocationData.address = addressData.formatted_address;
                
                hideStatus();
                
                // æ˜¾ç¤ºIPå®šä½ç»“æœç¡®è®¤
                const ipConfirmHtml = `
                    <div class="location-confirm">
                        <h2>ğŸŒ IPå®šä½ç»“æœ</h2>
                        <div class="address-big">${currentLocationData.address}</div>
                        <div class="accuracy-note">
                            å®šä½æ–¹å¼ï¼šIPå®šä½ | ç²¾åº¦èŒƒå›´ï¼šçº¦${Math.round(currentLocationData.accuracy)}ç±³
                            <br>ä½ç½®æ¥æºï¼š${ipResult.province} ${ipResult.city}
                        </div>
                        
                        <div class="distance-helper">
                            <p><strong>âš ï¸ æ³¨æ„ï¼š</strong>IPå®šä½ç²¾åº¦ç›¸å¯¹è¾ƒä½ï¼Œå»ºè®®è¿›ä¸€æ­¥ç¡®è®¤ä½ç½®ã€‚</p>
                        </div>
                        
                        <div class="confirm-buttons">
                            <button class="btn-yes" onclick="handleLocationConfirm('yes')">âœ… ä½ç½®å¤§è‡´æ­£ç¡®</button>
                            <button class="btn-unknown" onclick="showManualLocationInput()">âœï¸ æ‰‹åŠ¨è¾“å…¥ç²¾ç¡®ä½ç½®</button>
                            <button class="btn-no" onclick="restartLocation()">ğŸ”„ é‡æ–°å®šä½</button>
                        </div>
                    </div>
                `;
                
                locationConfirm.innerHTML = ipConfirmHtml;
                locationConfirm.style.display = 'block';
                collaborationInterface.style.display = 'block';
                
                updateAccuracyLevel(1); // IPå®šä½ä¸ºåŒºåŸŸçº§
                
            } catch (error) {
                showStatus(`âŒ IPå®šä½å¤±è´¥: ${error.message}`, 'error');
                setTimeout(() => showManualLocationInput(), 2000);
            }
        }



        // é¡µé¢åˆå§‹åŒ–
        function initializePage() {
            const device = detectDevice();
            const deviceStatusSpan = document.getElementById('deviceStatus');
            
            let statusText = '';
            let supportInfo = '';
            
            if (device.isMobile) {
                statusText = 'ğŸ“± ç§»åŠ¨è®¾å¤‡';
                supportInfo = device.hasGPS ? 
                    'æ”¯æŒï¼šGPSå®šä½ã€IPå®šä½ã€æ‰‹åŠ¨è¾“å…¥' : 
                    'æ”¯æŒï¼šIPå®šä½ã€æ‰‹åŠ¨è¾“å…¥';
            } else {
                statusText = 'ğŸ’» ç”µè„‘è®¾å¤‡';
                supportInfo = device.hasGPS ? 
                    'æ”¯æŒï¼šGPSå®šä½(ç²¾åº¦è¾ƒä½)ã€IPå®šä½ã€æ‰‹åŠ¨è¾“å…¥' : 
                    'æ”¯æŒï¼šIPå®šä½ã€æ‰‹åŠ¨è¾“å…¥';
            }
            
            if (deviceStatusSpan) {
                deviceStatusSpan.innerHTML = `${statusText} | ${supportInfo}`;
            }
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            if (device.isDesktop) {
                locationBtn.textContent = 'ğŸš€ å¼€å§‹æ™ºèƒ½å®šä½ (ç”µè„‘ç«¯å…¼å®¹)';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializePage);
        
        // ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        locationBtn.addEventListener('click', getCurrentLocation);
    </script>
</body>
</html>
